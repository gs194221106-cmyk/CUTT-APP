<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CATT">
    <title>ç§å¯†èŠå¤©å®¤ - éŸ©ç³»é£æ ¼ç‰ˆ</title>
    <style>
        :root {
            --rwawechat-light: #F7F7F7;
            --wechat-white: #FFFFFF;
            --wechat-gray: #EDEDED;
            --wechat-dark: #1A1A1A;
            --wechat-text: #333333;
            --wechat-time: #B2B2B2;
            --bubble-user: #E7F2FF;
            --bubble-bot: #FFFFFF;
            --light-blue: var(--bubble-user);
            --quote-bg: #FAFAFA;
            --quote-border-user: #FFCECE;
            --quote-border-bot: var(--bubble-user);
            --korea-primary: #FFB6C1;

            /* æ–°å¢ï¼šè§’è‰²ä¿¡æ¯é¢œè‰²å˜é‡ - é»˜è®¤æµ…è‰²ä¸»é¢˜ */
            --header-text-color: rgba(255, 255, 255, 0.9);
            --header-status-color: rgba(255, 255, 255, 0.8);
            --header-settings-color: rgba(255, 255, 255, 0.9);
            --header-text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);

            /* iOSé£æ ¼æ‚¬æµ®å¡ç‰‡å˜é‡ - ä¿®æ”¹ï¼šå…¨å±ç™½è‰²èƒŒæ™¯ */
            --ios-bg: #FFFFFF;
            --ios-card-bg: #F8F8F8;
            /* æµ…ç°è‰²å¡ç‰‡èƒŒæ™¯ */
            --ios-border: rgba(0, 0, 0, 0.08);
            --ios-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --ios-radius: 0;
            /* å…¨å±æ— åœ†è§’ */
            --ios-text-primary: #000000;
            --ios-text-secondary: #8E8E93;
            --ios-text-tertiary: #C7C7CC;
            --ios-divider: #E5E5EA;
            --ios-hover: #EFEFF4;
            --ios-active: #E5E5EA;
            /* é€‰ä¸­çŠ¶æ€æµ…ç°è‰² */
            --ios-blue: #8E8E93;
            --ios-red: #FF3B30;

            /* é¢æ¿å°ºå¯¸ - ä¿®æ”¹ï¼šå…¨å± */
            --panel-width: 100vw;
            --panel-height: 100vh;
            --panel-padding: 20px;

            /*èŠå¤©é¡µé¢å¤´åƒ*/
            --avatar-size: 32px;
            --avatar-gap: 12px;

        }

        /* æ·±è‰²ä¸»é¢˜å˜é‡ - è°ƒæ•´ä¸ºè¾ƒæµ…çš„é»‘è‰² */
        .dark-theme {
            --header-text-color: rgba(60, 60, 60, 0.95);
            --header-status-color: rgba(60, 60, 60, 0.75);
            --header-settings-color: rgba(60, 60, 60, 0.95);
            --header-text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background-color: var(--wechat-light);
            height: 100vh;
            overflow: hidden;
            touch-action: pan-y;
        }

        .container {
            background: #ffffff;
        }

        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }


        /* =========================
   å¤´éƒ¨å¤–å£³ï¼ˆä¸å«ç³»ç»ŸçŠ¶æ€æ ï¼‰
   ========================= */
        .header-card {
            position: relative;
            width: 100%;
            height: 75px;
            background: #ffffff;
            box-shadow: inset 0 -0.5px 1px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        /* =========================
   å¤´éƒ¨ - è§’è‰²çŠ¶æ€æ 
   ========================= */
        .header {
            position: absolute;
            top: 0;
            bottom: 22.67px;

            left: 19.67px;
            right: 19.67px;

            height: 60px;
            background: #ffffff;
            border-radius: 14px;

            display: flex;
            align-items: center;
            justify-content: space-between;

            padding-left: 31px;

            box-shadow:
                0 0 0.8px rgba(0, 0, 0, 0.03),
                0 0.5px 14px rgba(0, 0, 0, 0.04);
        }

        .header-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        /* =========================
   å¤´åƒ + çŠ¶æ€æ•´ä½“å®¹å™¨
   ========================= */
        .avatar-container {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        /* ç”¨äºæ‰¿è½½å¤´åƒ + åœ¨çº¿ç‚¹ï¼ˆä¸å‚ä¸å¸ƒå±€ï¼‰ */
        .avatar-wrapper {
            position: relative;
            width: 37px;
            height: 37px;
            margin-right: 10px;
            /* âœ… å¤´åƒä¸æ–‡å­—çš„çœŸå®é—´è· */
        }

        /* =========================
   å¤´åƒæœ¬ä½“ï¼ˆä¿æŒåŸæ ·ï¼‰
   ========================= */
        .avatar {
            width: 100%;
            height: 100%;

            border-radius: 50%;
            object-fit: cover;

            background-color: var(--light-pink);

            display: flex;
            justify-content: center;
            align-items: center;

            color: white;
            font-weight: 600;
            font-size: 15px;

            box-shadow: 0 0 0 2px #fff, 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        /* =========================
   åœ¨çº¿çŠ¶æ€ç‚¹ï¼ˆç™½åœˆ + ç»¿ç‚¹ï¼‰
   ========================= */
        .online-status {
            position: absolute;
            right: -2px;
            bottom: 1px;

            width: 11px;
            height: 11px;

            background: #ffffff;
            /* ç™½è‰²å¤–åœˆ */
            border-radius: 50%;

            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 6px 2px rgba(0, 0, 0, 0.04);
        }

        .online-status::after {
            content: "";
            width: 7px;
            height: 7px;
            border-radius: 50%;

            /* âœ… iOS / å¾®ä¿¡ç³» åœ¨çº¿ç»¿ */
            background-color: #4CD964;

            box-shadow: 0 0 0.5px rgba(0, 0, 0, 0.25);
        }


        /* =========================
   è§’è‰²ä¿¡æ¯æ–‡å­—
   ========================= */
        .chat-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            transform: translateY(0.73px);
        }

        .chat-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--header-text-color);
            line-height: 1.1;
            margin-bottom: 1.1px;
            text-shadow: var(--header-text-shadow);
        }

        .chat-status {
            font-size: 7px;
            line-height: 1.3;
            color: var(--header-status-color);
            text-shadow: var(--header-text-shadow);
        }

        /* =========================
   å³ä¾§æŒ‰é’®
   ========================= */
        .header-right {
            display: flex;
            align-items: center;
            margin-right: 27px;
        }

        .settings-btn {
            position: relative;
            overflow: visible;

            width: 30px;
            height: 24px;

            background: #000;
            border: none;
            border-radius: 6px;

            display: flex;
            align-items: center;
            justify-content: center;

            cursor: pointer;
            z-index: 1;
        }

        /* çˆ±å¿ƒ */
        .settings-btn::before {
            content: "â™¥";
            color: #fff;
            font-size: 11px;
            line-height: 1;

            position: relative;
            z-index: 2;
        }

        /* â†“â†“â†“ çœŸæ­£â€œè‡ªç„¶é•¿å‡ºæ¥â€çš„å°¾å·´ â†“â†“â†“ */
        .settings-btn::after {
            content: "";
            position: absolute;

            left: 50%;
            bottom: -1px;
            /* åƒè¿›æŒ‰é’®ä¸€ç‚¹ */

            width: 12px;
            height: 12px;

            background: #000;

            transform:
                translateX(-50%) rotate(45deg);

            border-radius: 3px;
            /* âœ… æ‰€æœ‰è§’éƒ½æ˜¯çœŸçš„åœ† */

            z-index: -1;
            /* âœ… å¿…é¡»åœ¨æŒ‰é’®ä¸‹é¢ */
            pointer-events: none;
        }

        .chat-wrapper {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        .chat-bg {
            position: absolute;
            inset: 0;
            background-color: #f2f2f2;
            z-index: 0;

            /* åªè´Ÿè´£èƒŒæ™¯ */
            background: none;
            /* ä¹‹å JS ä¼šæ”¹è¿™é‡Œ */

            pointer-events: none;
        }

        .chat-area {
            position: relative;
            z-index: 1;

            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;

            padding: 12px;
            padding-bottom: 12px;
            /* âœ… æ¯” 100px å°ä¸€æ¡£ */

            background: transparent;
        }

        .chat-area {
            --message-avatar-size: 32px;
            --message-avatar-gap: 10px;
        }

        /* æ°”æ³¡å®¹å™¨ï¼ˆå¤´åƒ + æ°”æ³¡æ•´ä½“ï¼‰ */
        .message-container {
            display: flex;
            margin-bottom: 17.5px;

            max-width: 85%;
            /* â­ å…³é”®ï¼šæ•´ä½“é™åˆ¶ */
            align-items: flex-start;
        }

        .user-container {
            margin-left: auto;
            margin-right: 5px;
            justify-content: flex-end;
        }

        .bot-container {
            margin-right: auto;
            margin-left: 5px;
        }

        .message {
            display: inline-block;

            padding: 8px 12px;
            border-radius: 14px;
            position: relative;
            animation: fadeIn 0.3s ease;

            font-size: 12.5px;
            line-height: 1.35;

            max-width: calc(100% - var(--avatar-size) - var(--avatar-gap));
            white-space: pre-wrap;
            word-break: break-word;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== å›¾ç‰‡ / è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼šå½»åº•ç§»é™¤æ°”æ³¡ ===== */
        .message.no-bubble,
        .message.no-bubble.user-message,
        .message.no-bubble.bot-message {
            background: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        /* ===== èŠå¤©æ¶ˆæ¯å¤´åƒ ===== */
        .message-avatar {
            width: var(--message-avatar-size);
            height: var(--message-avatar-size);
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: #ddd;

            display: flex;
            align-items: center;
            justify-content: center;

            font-size: 13px;
            font-weight: 500;
            color: #fff;

            transform: translateY(1px);
        }

        /* å¤´åƒé‡Œçš„å›¾ç‰‡ */
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ */
        .user-container {
            flex-direction: row;
        }

        .user-container .message-avatar {
            margin-left: var(--message-avatar-gap);
        }

        /* å¯¹æ–¹æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ */
        .bot-container {
            flex-direction: row;
        }

        .bot-container .message-avatar {
            margin-right: var(--message-avatar-gap);
        }

        .user-message {
            background-color: var(--bubble-user);
            color: var(--wechat-text);
            border-bottom-right-radius: 5px;
            box-shadow: inset 0 -0.5px 1px rgba(0, 0, 0, 0.03);
        }

        .bot-message {
            background-color: var(--bubble-bot);
            color: var(--wechat-text);
            border-bottom-left-radius: 5px;
            box-shadow:
                inset 0 -0.5px 1px rgba(0, 0, 0, 0.03),
                0 0.5px 1.5px rgba(0, 0, 0, 0.035);
        }


        /* ===== æ—¶é—´åˆ†å‰²çº¿ï¼ˆèƒ¶å›Šæ°”æ³¡ç‰ˆ Â· ç²¾ä¿®å°å·ï¼‰ ===== */
        .time-divider {
            text-align: center;
            margin: 12px 0;
            /* â¬… ä¸Šä¸‹é—´è·ç•¥æ”¶ */
            font-size: 9px;
            /* â¬… æ¯”æ¶ˆæ¯å†å°ä¸€æ¡£ */
            color: #8e8e93;

            position: relative;
        }

        .time-divider span {
            display: inline-block;

            padding: 2px 8px;
            /* â¬… å…³é”®ï¼šæ˜æ˜¾å‹æ‰é«˜åº¦ */
            border-radius: 999px;

            /* âœ… å®ä½“æµ…ç°ï¼Œä¸é€æ˜ */
            background-color: #ededed;

            line-height: 1.4;
            /* â¬… é˜²æ­¢å­—ä½“æ’‘é«˜ */
        }


        /* ===== åº•éƒ¨ç³»ç»Ÿæ ï¼ˆçº¯ç™½èƒŒæ™¯å±‚ï¼‰ ===== */
        .input-area {
            position: relative;
            width: 100%;
            height: 108px;
            /* ğŸ‘ˆ è¿™é‡Œï¼Œ88 â†’ 96 */
            background: #ffffff;
            box-shadow: inset 0 0.5px 1px rgba(0, 0, 0, 0.05);


            display: flex;
            align-items: center;
            padding: 0 16px;
            box-sizing: border-box;
        }



        /* ===== è¾“å…¥è¡Œï¼ˆæ‚¬æµ®å¡ç‰‡ï¼‰ ===== */
        /* ===== è¾“å…¥è¡Œï¼ˆæ‚¬æµ®å¡ç‰‡ï¼ŒTOOL çš„é”šç‚¹ï¼‰ ===== */
        .input-btn {
            position: absolute;
            /* â­ TOOL çš„å®šä½åŸºå‡† */
            left: 0;
            right: 0;

            bottom: 34px;
            /* 209 Ã· 3 */

            display: flex;
            align-items: center;
            gap: 14px;

            padding-left: 22px;
            /* 66 Ã· 3 */
            padding-right: 31px;
            /* 93 Ã· 3 */
        }


        /* ===== è¯­éŸ³æŒ‰é’®ï¼ˆ90 Ã· 3ï¼‰ ===== */
        .voice-btn {
            width: 30px;
            height: 30px;

            border-radius: 50%;
            border: none;
            padding: 0;

            background: #f2f2f2;

            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-icon {
            width: 18px;
            height: 18px;

            fill: none;
            stroke: #555;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* ===== TOOL æ ‡ç­¾ï¼ˆæ‚¬æµ®åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ï¼Œä¸éšå¤šè¡Œå˜åŒ–ï¼‰ ===== */
        .tool-label {
            position: absolute;

            top: -5px;
            /* ä¿ç•™ä½ çš„è®¾è®¡å€¼ */
            left: 88px;
            /* â‰ˆ è¯­éŸ³æŒ‰é’®å®½åº¦ + gapï¼ˆå¯å¾®è°ƒï¼‰ */

            font-family: "Montserrat", -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            font-style: italic;

            font-size: 11px;
            line-height: 1;
            letter-spacing: 0.4px;

            color: #777;
            background: transparent;

            z-index: 5;
            cursor: pointer;
            user-select: none;
        }

        .tool-arrow {
            font-size: 11px;
            line-height: 1;
        }

        /* =========================
   Tool Panelï¼ˆä¸¥æ ¼ Ã·3 è¿˜åŸç‰ˆï¼‰
   ========================= */
        .tool-panel {
            position: fixed;
            /* ğŸ”¥ æ”¹è¿™é‡Œï¼šå‡ºç”Ÿç‚¹ */
            top: 23%;
            left: 67%;
            transform: translate(-50%, -50%);
            /* â†‘ ä»â€œä¸­å¿ƒç‚¹â€å‡ºç”Ÿï¼Œè€Œä¸æ˜¯åº•éƒ¨ */
            z-index: 9999;

            /* âœ… è®¾è®¡ç¨¿ Ã·3 åçš„å›ºå®šå°ºå¯¸ */
            width: 185px;
            height: 57px;

            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);

            /* âœ… åœ†è§’ Ã·3 */
            border-radius: 22px;

            /* âœ… padding Ã·3 */
            padding: 7px 9px;

            /* âœ… é˜´å½± */
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.035),
                0 1.5px 6px rgba(0, 0, 0, 0.025);

            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        /* éšè—çŠ¶æ€ */
        .tool-panel.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, 20px);
        }

        .tool-panel-header {
            height: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-drag-bar {
            width: 23px;
            height: 1.5px;
            border-radius: 1px;
            background: rgba(0, 0, 0, 0.15);

            transform: translateY(-4.5px);
            /* ğŸ‘ˆ å‘ä¸Šæï¼Œ1~3px è‡ªå·±å¾®è°ƒ */
        }

        .tool-panel-header:active {
            cursor: grabbing;
        }


        .tool-panel-inner {
            display: flex;
            gap: 16px;
            justify-content: center;

            margin-top: 0px;
            /* ğŸ‘ˆ å¾€ä¸Šè´´ä¸€ç‚¹ */
        }


        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;

            /* â¬…ï¸ å›¾æ ‡å’Œæ–‡å­—çš„è·ç¦»è¦å…‹åˆ¶ */
            gap: 3px;

            background: none;
            border: none;
            padding: 0;

            cursor: pointer;

            color: #111;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;

            /* â¬…ï¸ æ–‡å­—ä¸€å®šè¦é€€å */
            font-size: 6px;
            font-weight: 500;
            opacity: 0.75;
        }

        /* SVG ç»Ÿä¸€å¤§å°ï¼ˆè¿™ä¸ªå€¼æ˜¯å¯¹çš„ï¼Œä¸ç”¨å†åŠ¨ï¼‰ */
        .tool-btn svg {
            width: 17px;
            height: 17px;
        }

        /* ç‚¹å‡»åé¦ˆ */
        .tool-btn:active {
            transform: scale(0.94);
            opacity: 0.8;
        }

        /* ===== è¾“å…¥æ¡†ä¸»ä½“ï¼ˆåŸºäºåŸå§‹ 50pxï¼‰ ===== */
        .input-wrapper {
            position: relative;
            flex: 1;

            min-height: 50px;
            /* å•è¡Œä¸¥æ ¼ 50px */
            max-height: 96px;
            /* ä¸‰è¡Œå°é¡¶ */

            border-radius: 14px;
            background: #ffffff;

            box-shadow:
                0 0 0.8px rgba(0, 0, 0, 0.03),
                0 4px 14px rgba(0, 0, 0, 0.03);

            overflow: hidden;
            /* âœ… å¿…é¡»ä¿ç•™ */
        }


        /* ===== æ–‡æœ¬è¾“å…¥ï¼ˆçœŸå¤šè¡Œ textareaï¼‰ ===== */
        .message-input {
            width: 100%;

            min-height: 50px;
            max-height: 96px;

            border: none;
            background: transparent;

            /* ç”¨ padding å®ç°å•è¡Œâ€œè§†è§‰å±…ä¸­â€ */
            padding: 16px 40px 16px 19px;

            font-size: 12px;
            line-height: 1.35;

            color: #333;

            resize: none;
            outline: none;
            overflow-y: auto;

            box-sizing: border-box;
        }

        /* ===== å‘é€æŒ‰é’® ===== */
        .send-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(calc(-50% - 1px));

            width: 36px;
            height: 36px;
            border-radius: 50%;

            border: none;
            background: #ffffff;
            color: #333;

            font-size: 14px;
            padding: 0;
        }


        /* ä¿®æ”¹ï¼šè¾“å…¥æ placeholderå­—ä½“å¤§å° */
        .message-input::placeholder {
            font-size: 12px;
            color: var(--wechat-time);
        }

        /* è®¾ç½®é¢æ¿ - ä¿®æ”¹ï¼šå…¨å±ç™½è‰²èƒŒæ™¯ */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--panel-width);
            height: var(--panel-height);
            background: var(--ios-bg);
            /* ç™½è‰²èƒŒæ™¯ */
            padding: var(--panel-padding);
            overflow-y: auto;
            overflow-x: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            touch-action: pan-y;
            box-shadow: none;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.active {
            transform: translateX(0);
        }

        /* è®¾ç½®é¢æ¿å†…å®¹æ ·å¼ */
        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 18px;
            flex: 1;
            overflow-y: auto;
        }

        /* è®¾ç½®åŒºå—å¡ç‰‡ - ä¿®æ”¹ï¼šæ·»åŠ æµ…ç°è‰²èƒŒæ™¯å’Œæ·¡æ·¡é˜´å½± */
        .setting-section {
            background: var(--ios-card-bg);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--ios-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            /* æ·»åŠ æ·¡æ·¡é˜´å½± */
        }

        /* è®¾ç½®åŒºå—æ ‡é¢˜ */
        .setting-section h3 {
            margin-bottom: 14px;
            color: var(--ios-text-primary);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        /* è®¾ç½®é¢æ¿å¤´éƒ¨ */
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--ios-divider);
            flex-shrink: 0;
        }

        .settings-header h2 {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-text-primary);
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .close-settings:hover {
            background: var(--ios-hover);
        }

        /* èƒ¶å›ŠæŒ‰é’® - ä¿®æ”¹ï¼šèƒŒæ™¯æ”¹ä¸ºé»‘è‰² */
        .capsule-btn {
            background-color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .capsule-btn:hover {
            opacity: 0.9;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .glass-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--ios-divider);
            border-radius: 8px;
            font-size: 13px;
            background: var(--ios-card-bg);
            transition: all 0.2s;
            margin-bottom: 10px;
            color: var(--ios-text-primary);
        }

        .glass-input:focus {
            outline: none;
            border-color: var(--ios-blue);
        }

        /* å¼€å…³æ ·å¼ */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .toggle-label {
            font-size: 13px;
            color: var(--ios-text-primary);
            font-weight: 400;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--ios-divider);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        input:checked+.toggle-slider {
            background-color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
        }

        input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        /* æè¿°æ–‡å­— */
        .toggle-description {
            font-size: 11px;
            color: var(--ios-text-tertiary);
            margin-top: 4px;
            line-height: 1.4;
        }

        /* å­—å¡å¡ç‰‡æ ·å¼ - ä¿®æ”¹ï¼šå¯¹é½å’ŒæŒ‰é’®æ ·å¼ */
        .item-list {
            max-height: 150px;
            overflow-y: auto;
            border-radius: 8px;
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            gap: 6px;
        }

        .phrase-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--ios-card-bg);
            transition: all 0.2s;
            border: 1px solid var(--ios-divider);
            margin-bottom: 6px;
        }

        .phrase-card:hover {
            background: var(--ios-hover);
        }

        .phrase-text {
            flex: 1;
            font-size: 12px;
            color: var(--ios-text-primary);
            margin-right: 10px;
            word-break: break-word;
        }

        .phrase-actions {
            display: flex;
            gap: 4px;
            /* ç¼©å°æŒ‰é’®é—´è· */
        }

        .phrase-edit-btn,
        .phrase-delete-btn {
            background: var(--ios-card-bg);
            /* ä¸å¡ç‰‡ç›¸åŒé¢œè‰² */
            color: var(--ios-text-primary);
            border: 1px solid var(--ios-divider);
            /* æµ…ç°è‰²è¾¹æ¡† */
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
            /* æ›´å°çš„å­—ä½“ */
            padding: 2px 6px;
            /* æ›´å°çš„å†…è¾¹è· */
            transition: all 0.2s;
        }

        .phrase-edit-btn:hover,
        .phrase-delete-btn:hover {
            background: var(--ios-hover);
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--ios-red);
            cursor: pointer;
            font-size: 12px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* Emojiå’Œè¡¨æƒ…åŒ…æ ·å¼ - ä¿®æ”¹ï¼šè¡¨æƒ…åŒ…é—´è·è°ƒæ•´ */
        .emoji-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(34px, 1fr));
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
        }

        .emoji-item {
            font-size: 20px;
            cursor: pointer;
            position: relative;
            width: 34px;
            height: 34px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            background: var(--ios-divider);
            transition: transform 0.2s;
        }

        .emoji-item:hover {
            transform: scale(1.1);
            background: var(--ios-hover);
        }

        .emoji-item .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--ios-red);
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 9px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* è¡¨æƒ…åŒ…å›¾ç‰‡æ ·å¼ */
        .image-option {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
            background: var(--ios-divider);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .image-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .image-option:hover {
            transform: scale(1.05);
        }

        .image-option .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--ios-red);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ·»åŠ é¡¹ç›®æ ·å¼ - ä¿®æ”¹ï¼šæ·»åŠ æŒ‰é’®é«˜åº¦è°ƒæ•´ */
        .add-item {
            display: flex;
            margin-bottom: 10px;
            gap: 8px;
        }

        .add-item input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--ios-divider);
            border-radius: 8px;
            font-size: 13px;
            background: var(--ios-card-bg);
            color: var(--ios-text-primary);
            height: 36px;
            cursor: pointer;
        }

        .add-item .capsule-btn {
            height: 36px;
            padding: 0 14px;
            display: flex;
            align-items: center;
        }

        /* å­˜å‚¨ä¿¡æ¯æ ·å¼ */
        .storage-info {
            background: var(--ios-divider);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 14px;
            font-size: 12px;
            color: var(--ios-text-secondary);
        }

        /* æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .button-group .capsule-btn {
            flex: 1;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ - ä¿®æ”¹ï¼šæŒ‰é’®é¢œè‰² */
        .theme-toggle-buttons {
            display: flex;
            gap: 8px;
        }

        .theme-btn {
            padding: 8px 12px;
            border: 1px solid var(--ios-divider);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background: var(--ios-card-bg);
            color: var(--ios-text-primary);
            flex: 1;
        }

        .theme-btn:hover {
            background: var(--ios-hover);
        }

        .theme-btn.active {
            background-color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
            color: white;
            border-color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
        }

        /* å¤´åƒé¢„è§ˆæ ·å¼ */
        .avatar-preview {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
        }

        /* èƒŒæ™¯é¢„è§ˆæ ·å¼ */
        .background-preview {
            margin-top: 15px;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background: var(--ios-divider);
        }

        /* å‹ç¼©è¿›åº¦æ¡æ ·å¼ */
        .compression-progress {
            width: 100%;
            height: 3px;
            background-color: var(--ios-divider);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .compression-progress-bar {
            height: 100%;
            background-color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
            width: 0%;
            transition: width 0.3s;
        }

        .compression-info {
            font-size: 11px;
            color: var(--ios-text-tertiary);
            margin-top: 4px;
        }

        /* å¥½å‹é¢æ¿æ ·å¼ - ä¿®æ”¹ï¼šå…¨å±ç™½è‰²èƒŒæ™¯ */
        .friends-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--panel-width);
            height: var(--panel-height);
            background: var(--ios-bg);
            /* ç™½è‰²èƒŒæ™¯ */
            padding: var(--panel-padding);
            overflow-y: auto;
            overflow-x: hidden;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 100;
            touch-action: pan-y;
            box-shadow: none;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }

        .friends-panel.active {
            transform: translateX(0);
        }

        .friends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--ios-divider);
            flex-shrink: 0;
        }

        .friends-header h2 {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-text-primary);
        }

        .add-friend-header-btn {
            background: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-friend-header-btn:hover {
            opacity: 0.9;
        }

        .close-friends {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #000000;
            /* ä¿®æ”¹ï¼šæ”¹ä¸ºé»‘è‰² */
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .close-friends:hover {
            background: var(--ios-hover);
        }

        /* å¥½å‹åˆ—è¡¨æ ·å¼ - ä¿®æ”¹ï¼šé€‰ä¸­çŠ¶æ€ */
        .friend-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            background: var(--ios-card-bg);
            height: 60px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 1px solid var(--ios-divider);
        }

        .friend-item:hover {
            background: var(--ios-hover);
        }

        .friend-item.active {
            background: var(--ios-active);
            /* æ›´æµ…çš„ç°è‰² */
            border-color: var(--ios-divider);
        }

        /* åˆ é™¤å·¦ä¾§è“æ¡ */
        .friend-item.active::before {
            display: none;
        }

        .friend-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--light-pink);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
            overflow: hidden;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 13px;
            color: var(--ios-text-primary);
            margin-bottom: 2px;
            font-weight: 500;
        }

        .friend-last-message {
            font-size: 11px;
            color: var(--ios-text-tertiary);
        }

        /* æœªè¯»æ¶ˆæ¯æç¤ºæ ·å¼ - æ–°å¢ */
        .unread-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #FF3B30;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* æ·»åŠ å¥½å‹å¼¹çª—æ ·å¼ */
        .add-friend-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--ios-card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--ios-shadow);
            z-index: 200;
            width: 280px;
            display: none;
            border: 1px solid var(--ios-border);
        }

        .add-friend-popup.active {
            display: block;
        }

        .add-friend-popup h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--ios-text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .add-friend-popup-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .add-friend-popup-buttons .capsule-btn {
            flex: 1;
        }

        .add-friend-popup-buttons .capsule-btn.cancel {
            background: var(--ios-divider);
            color: var(--ios-text-primary);
        }

        .add-friend-popup-buttons .capsule-btn.cancel:hover {
            background: var(--ios-hover);
        }

        /* é®ç½©å±‚ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 99;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* å…¶ä½™æ ·å¼ä¿æŒä¸å˜ */
        .hidden {
            display: none !important;
        }

        /* ===== Sticker Pickerï¼ˆè·Ÿéš Tool Panel åº•éƒ¨å‡ºç°ï¼‰ ===== */
        .sticker-picker {
            position: absolute;

            top: 100%;
            /* ğŸ”¥ ä» panel åº•éƒ¨å‡ºç”Ÿ */
            left: 50%;
            transform: translateX(-50%);
            width: 99%;
            /* ğŸ”¥ å’Œ panel åŒå®½ */

            margin-top: 6px;
            /* panel ä¸ sticker çš„é—´è· */

            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);

            border-radius: 20px;
            padding: 12px;

            height: 160px;
            /* æ¯”ä½ åŸæ¥ 150 ç•¥å¤§ä¸€ç‚¹ */
            overflow-y: auto;
            overflow-x: hidden;

            box-shadow:
                0 3px 14px rgba(0, 0, 0, 0.04),
                0 1px 4px rgba(0, 0, 0, 0.025);

            z-index: 10;

            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(52px, 1fr));
            gap: 6px;
            /* ğŸ”¥ æ¯”ä¹‹å‰æ›´ç´§å‡‘ */
            align-content: flex-start;

            touch-action: pan-y;
            box-sizing: border-box;
        }

        .multi-file-label {
            display: block;
            margin-top: 10px;
            font-size: 13px;
            color: var(--wechat-text);
        }

        .multi-emoji-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--wechat-gray);
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .multi-emoji-tip {
            font-size: 11px;
            color: var(--wechat-time);
            margin-bottom: 10px;
        }

        .smile-icon {
            width: 24px;
            height: 24px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .smile-icon::before {
            content: "";
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: var(--bubble-user);
            border-radius: 50%;
            box-shadow: 0 0 0 6px rgba(255, 182, 193, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .link-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }

        .link-icon::before {
            content: "";
            position: absolute;
            top: 6px;
            left: 4px;
            width: 8px;
            height: 8px;
            border: 2px solid var(--bubble-user);
            border-radius: 2px;
            transform: rotate(45deg);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .link-icon::after {
            content: "";
            position: absolute;
            bottom: 6px;
            right: 4px;
            width: 8px;
            height: 8px;
            border: 2px solid var(--bubble-user);
            border-radius: 2px;
            transform: rotate(45deg);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .hidden-file-input {
            display: none;
        }

        .chat-history-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .clear-history-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            flex: 1;
        }

        .clear-history-btn:hover {
            background-color: #ff5252;
        }

        .export-history-btn {
            background-color: var(--korea-primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            flex: 1;
        }

        .export-history-btn:hover {
            background-color: #ff4d8a;
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .confirm-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        .confirm-title {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--wechat-text);
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .confirm-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .confirm-yes {
            background-color: #ff6b6b;
            color: white;
        }

        .confirm-no {
            background-color: var(--wechat-gray);
            color: var(--wechat-text);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 30;
            flex-direction: column;
        }

        .loading-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--wechat-text);
        }

        .indexeddb-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-size: 11px;
        }

        .status-ok {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .export-textarea {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            background-color: white;
            border: 1px solid var(--wechat-gray);
            border-radius: 12px;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
        }

        .export-textarea textarea {
            flex: 1;
            width: 100%;
            border: 1px solid var(--wechat-gray);
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
            resize: none;
            font-family: monospace;
        }

        .export-textarea-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .export-textarea-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .copy-btn {
            background-color: var(--korea-primary);
            color: white;
        }

        .close-export-btn {
            background-color: var(--wechat-gray);
            color: var(--wechat-text);
        }

        .export-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--korea-primary);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 100;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeInOut 2s ease-in-out;
            display: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .storage-optimization {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--wechat-text);
        }

        .optimization-options {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .optimization-btn {
            padding: 8px 12px;
            background-color: var(--korea-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .optimization-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(255, 107, 157, 0.3);
        }

        .optimization-info {
            font-size: 11px;
            color: var(--wechat-time);
            margin-top: 5px;
        }

        .copy-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--korea-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 100;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeInOut 2s ease-in-out;
            display: none;
        }

        /* æ¶ˆæ¯æ“ä½œèœå• */
        .message-action-menu {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 4px 0;
            z-index: 50;
            display: none;
            flex-direction: row;
            min-width: 80px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transform: translateY(-100%);
            top: -35px;
        }

        .action-menu-item {
            padding: 6px 10px;
            border: none;
            background: none;
            text-align: center;
            cursor: pointer;
            font-size: 11px;
            color: var(--wechat-text);
            transition: background-color 0.2s;
            flex: 1;
        }

        .action-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* å¼•ç”¨æ¶ˆæ¯çš„æ•´ä½“æ°”æ³¡æ ·å¼ */
        .message-with-quote {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .quoted-content {
            background-color: var(--quote-bg);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--quote-border-bot);
            font-size: 11px;
            color: var(--wechat-time);
        }

        .user-message .quoted-content {
            border-left-color: white;
        }

        .quoted-text {
            font-size: 11px;
            color: var(--wechat-text);
            margin-top: 4px;
        }

        .main-content {
            font-size: 12.5px;
            color: var(--wechat-text);
            line-height: 1.35;
        }

        /* ä¼˜åŒ–å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
        .file-upload-btn {
            background-color: var(--korea-primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: inline-block;
            text-align: center;
        }

        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(255, 107, 157, 0.3);
        }

        .file-input-container {
            margin-bottom: 10px;
        }

        .avatar-preview {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
        }

        /* åˆå§‹åŠ è½½åŠ¨ç”» */
        .initial-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--wechat-white);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 182, 193, 0.3);
            border-radius: 50%;
            border-top-color: var(--korea-primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* æ–°å¢ï¼šä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .theme-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .theme-toggle-label {
            font-size: 14px;
            color: var(--wechat-text);
        }

        /* è¡¨æƒ…åŒ…ç½‘æ ¼å®¹å™¨ */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
        }

        /* æ–°å¢ï¼šå¼•ç”¨æ¶ˆæ¯ä¸­çš„å›¾ç‰‡æ ·å¼ */
        .quoted-image {
            max-width: 60px;
            max-height: 60px;
            border-radius: 4px;
            margin-top: 4px;
            object-fit: cover;
        }

        /* æ–°å¢ï¼šæ‰¹é‡å­—å¡è¾“å…¥å¼¹çª—æ ·å¼ */
        .batch-phrase-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--ios-card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--ios-shadow);
            z-index: 200;
            width: 320px;
            display: none;
            border: 1px solid var(--ios-border);
        }

        .batch-phrase-popup.active {
            display: block;
        }

        .batch-phrase-popup h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--ios-text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .batch-phrase-textarea {
            width: 100%;
            height: 180px;
            padding: 12px;
            border: 1px solid var(--ios-divider);
            border-radius: 8px;
            font-size: 13px;
            resize: none;
            margin-bottom: 16px;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.4;
            background: var(--ios-card-bg);
            color: var(--ios-text-primary);
        }

        .batch-phrase-textarea:focus {
            outline: none;
            border-color: var(--ios-blue);
        }

        .batch-phrase-tip {
            font-size: 11px;
            color: var(--ios-text-tertiary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .batch-phrase-popup-buttons {
            display: flex;
            gap: 8px;
        }

        .batch-phrase-popup-buttons .capsule-btn {
            flex: 1;
        }

        .batch-phrase-popup-buttons .capsule-btn.cancel {
            background: var(--ios-divider);
            color: var(--ios-text-primary);
        }

        .batch-phrase-popup-buttons .capsule-btn.cancel:hover {
            background: var(--ios-hover);
        }

        /* æ–°å¢ï¼šå­—å¡ç®¡ç†å¼¹çª—æ ·å¼ - é‡æ–°è®¾è®¡ */
        .phrase-more-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--ios-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--ios-shadow);
            z-index: 200;
            width: 320px;
            display: none;
            border: 1px solid var(--ios-border);
        }

        .phrase-more-popup.active {
            display: block;
        }

        .phrase-more-popup h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--ios-text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        /* å­—å¡ç®¡ç†å¼¹çª—å†…å®¹æ ·å¼ */
        .phrase-more-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* åˆ é™¤æ‰€æœ‰å­—å¡æŒ‰é’® - å‚è€ƒæ¸…é™¤èŠå¤©è®°å½•çš„æ ·å¼ */
        .phrase-delete-all-btn {
            background-color: #000000;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }

        .phrase-delete-all-btn:hover {
            opacity: 0.9;
        }

        /* æœç´¢åŒºåŸŸæ ·å¼ */
        .phrase-search-section {
            margin-top: 16px;
        }

        /* æœç´¢è¾“å…¥æ¡†å®¹å™¨ - ä¸è®¾ç½®ç•Œé¢çš„å­—å¡è¾“å…¥æ¡†é«˜åº¦ä¸€è‡´ */
        .phrase-search-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* æœç´¢è¾“å…¥æ¡† - ä¸è®¾ç½®ç•Œé¢çš„glass-inputé«˜åº¦ä¸€è‡´ */
        .phrase-search-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--ios-divider);
            border-radius: 8px;
            font-size: 13px;
            background: var(--ios-card-bg);
            color: var(--ios-text-primary);
            height: 36px;
        }

        .phrase-search-input:focus {
            outline: none;
            border-color: var(--ios-blue);
        }

        /* æœç´¢æŒ‰é’® - ä¸æœç´¢æ ä¸€ä¸ªé«˜åº¦ */
        .phrase-search-btn {
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            padding: 0 16px;
            transition: all 0.2s;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phrase-search-btn:hover {
            opacity: 0.9;
        }

        /* æœç´¢ç»“æœæ ‡é¢˜ */
        .search-results-title {
            font-size: 12px;
            color: var(--ios-text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        /* æœç´¢ç»“æœåŒºåŸŸ */
        .phrase-search-results {
            max-height: 150px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--ios-divider);
            padding: 8px;
            background: var(--ios-card-bg);
        }

        .phrase-search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            background: var(--ios-card-bg);
            border: 1px solid var(--ios-divider);
        }

        .phrase-search-result-item:hover {
            background: var(--ios-hover);
        }

        .phrase-search-result-text {
            flex: 1;
            font-size: 12px;
            color: var(--ios-text-primary);
            margin-right: 8px;
            word-break: break-word;
        }

        .phrase-search-result-actions {
            display: flex;
            gap: 4px;
        }

        .phrase-search-edit-btn,
        .phrase-search-delete-btn {
            background: var(--ios-card-bg);
            color: var(--ios-text-primary);
            border: 1px solid var(--ios-divider);
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
            padding: 2px 6px;
            transition: all 0.2s;
        }

        .phrase-search-edit-btn:hover,
        .phrase-search-delete-btn:hover {
            background: var(--ios-hover);
        }

        .no-results {
            text-align: center;
            font-size: 12px;
            color: var(--ios-text-tertiary);
            padding: 10px;
        }

        /* å…³é—­æŒ‰é’® */
        .close-phrase-more-popup-btn {
            background-color: #000000;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
            margin-top: 8px;
        }

        .close-phrase-more-popup-btn:hover {
            opacity: 0.9;
        }

        /* ===== å¼•ç”¨ä¸­çš„å›¾ç‰‡ / è¡¨æƒ…åŒ…ï¼šå¼ºåˆ¶ç¼©ç•¥å›¾é™é«˜ï¼ˆæœ€ç»ˆç‰ˆï¼‰ ===== */
        .quoted-content .quoted-text img.quoted-image {
            max-height: 64px !important;
            max-width: 96px !important;
            width: auto !important;
            height: auto !important;
            object-fit: cover;
            border-radius: 6px;
            display: block;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* â—é”æ­»æ»šåŠ¨ */
            overscroll-behavior: none;
            touch-action: none;
        }
    </style>
</head>

<body>
    <!-- åˆå§‹åŠ è½½åŠ¨ç”» -->
    <div class="initial-loading" id="initialLoading">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½ä¼ è®¯å®¤...</div>
    </div>

    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>
    <div class="container" id="mainContainer">

        <!-- é¡¶éƒ¨ Headerï¼ˆåªæ”¾ headerï¼‰ -->
        <div class="header-card">
            <div class="header">
                <div class="header-left">
                    <div class="avatar-container" id="avatarContainer">

                        <!-- å¤´åƒ + åœ¨çº¿çŠ¶æ€åŒ…è£¹ -->
                        <div class="avatar-wrapper">
                            <div class="avatar" id="botAvatar">
                                <!-- å¤´åƒå›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>

                            <!-- åœ¨çº¿çŠ¶æ€ç‚¹ -->
                            <span class="online-status"></span>
                        </div>

                        <div class="chat-info">
                            <div class="chat-title" id="botName">èŠå¤©ä¼™ä¼´</div>
                            <div class="chat-status" id="chatStatus">åœ¨çº¿</div>
                        </div>
                    </div>
                </div>

                <div class="header-right">
                    <button class="settings-btn">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </div>


        <!-- ä¸­é—´èŠå¤©åŒºåŸŸï¼ˆèƒŒæ™¯ + æ»šåŠ¨ï¼‰ -->
        <div class="chat-wrapper">
            <div class="chat-bg" id="chatBg"></div>
            <div class="chat-area" id="chatArea">
                <!-- èŠå¤©æ¶ˆæ¯ -->
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥åŒºï¼ˆç³»ç»Ÿå±‚ï¼Œçº¯ç™½ï¼‰ -->
        <div class="input-card">

            <div class="input-area">
                <div class="input-btn">
                    <!-- â­ TOOL å¡åœ¨â€œè¾“å…¥æ¡†â€ä¸Š -->
                    <div class="tool-label" id="toolToggle">
                        TOOL <span class="tool-arrow">^</span>
                    </div>
                    <!-- è¯­éŸ³ -->
                    <!-- è¯­éŸ³ -->
                    <button id="voiceBtn" class="voice-btn" type="button" aria-label="è¯­éŸ³">
                        <svg class="voice-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="6" cy="12" r="2"></circle>
                            <path d="M11 9a4 4 0 0 1 0 6"></path>
                            <path d="M14 6a7 7 0 0 1 0 12"></path>
                        </svg>
                    </button>

                    <!-- è¾“å…¥æ¡† -->
                    <div class="input-wrapper">

                        <textarea class="message-input" id="messageInput" placeholder="iMessageâ€¦" rows="1"></textarea>

                        <button class="send-btn" id="sendBtn">â¤</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- =========================
     Tool Floating Panel å¯ç§»åŠ¨å·¥å…·çª—å£
     ========================= -->
        <div id="tool-panel" class="tool-panel hidden">
            <!-- Image ä¸Šä¼  inputï¼ˆå¿…é¡»å­˜åœ¨ï¼ŒJS æ‰èƒ½ clickï¼‰ -->
            <input type="file" id="imageFileInput" class="hidden-file-input" accept="image/*" />
            <!-- ğŸ”¹ å¯æ‹–æ‹½å¤´éƒ¨ï¼ˆå”¯ä¸€æ‹–æ‹½åŒºï¼‰ -->
            <div class="tool-panel-header" id="toolPanelDrag">
                <!-- å¯é€‰ï¼šiOS é£æ ¼å°æ¨ªæ¡ -->
                <div class="tool-drag-bar"></div>
            </div>
            <div class="sticker-picker hidden" id="stickerPicker">
                <!-- è¡¨æƒ…åŒ…é€‰æ‹©å™¨å†…å®¹ -->
            </div>
            <!-- ğŸ”¹ å·¥å…·æŒ‰é’®åŒºï¼ˆä¸å¯æ‹–æ‹½ï¼‰ -->
            <div class="tool-panel-inner">


                <!-- Sticker -->
                <button class="tool-btn tool-sticker-btn">
                    <!-- Sticker SVG -->
                    <svg class="tool-icon" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 26C14 26 17 30 22 30C27 30 30 26 30 26
         M16 16H16.02
         M28 16H28.02
         M42 22C42 33.0457 33.0457 42 22 42
         C10.9543 42 2 33.0457 2 22
         C2 10.9543 10.9543 2 22 2
         C33.0457 2 42 10.9543 42 22Z" stroke="currentColor" stroke-width="3.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>

                    <span>Sticker</span>
                </button>

                <!-- Image -->
                <button class="tool-btn tool-image-btn">
                    <!-- Image SVG -->
                    <svg class="tool-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M35 13H35.02
         M14 4H34C39.5228 4 44 8.47715 44 14V34
         C44 39.5228 39.5228 44 34 44H14
         C8.47715 44 4 39.5228 4 34V14
         C4 8.47715 8.47715 4 14 4Z
         M32 22.74C32.2468 24.4045 31.9625 26.1044
         31.1875 27.598C30.4125 29.0916
         29.1863 30.3028 27.6833 31.0593
         C26.1802 31.8159 24.4769 32.0792
         22.8156 31.8119C21.1543 31.5445
         19.6195 30.7602 18.4297 29.5703
         C17.2398 28.3805 16.4555 26.8457
         16.1881 25.1844C15.9208 23.5231
         16.1841 21.8198 16.9407 20.3167
         C17.6972 18.8137 18.9084 17.5875
         20.402 16.8125C21.8956 16.0375
         23.5955 15.7532 25.26 16
         C26.9578 16.2518 28.5297 17.0429
         29.7434 18.2566C30.9571 19.4703
         31.7482 21.0422 32 22.74Z" stroke="currentColor" stroke-width="3.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>

                    <span>Image</span>
                </button>

                <!-- Call -->
                <button class="tool-btn tool-call-btn">
                    <!-- Call SVG -->
                    <svg class="tool-icon" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M27.8762 10
         C29.8297 10.3811 31.625 11.3365 33.0324 12.7439
         C34.4397 14.1512 35.3951 15.9465 35.7762 17.9
         M27.8762 2
         C31.9348 2.45087 35.7194 4.26835 38.6087 7.15402
         C41.498 10.0397 43.3203 13.822 43.7762 17.88
         M41.7762 33.84V39.84
         C41.7785 40.397 41.6644 40.9483 41.4413 41.4587
         C41.2181 41.9691 40.8908 42.4272 40.4804 42.8037
         C40.0699 43.1803 39.5854 43.467 39.0577 43.6454
         C38.5301 43.8239 37.971 43.8901 37.4162 43.84
         C31.2619 43.1713 25.3502 41.0683 20.1562 37.7
         C15.3239 34.6293 11.2269 30.5323 8.15623 25.7
         C4.77619 20.4824 2.67272 14.542 2.01623 8.36
         C1.96625 7.80693 2.03198 7.24952 2.20923 6.72325
         C2.38649 6.19698 2.67138 5.71338 3.04577 5.30324
         C3.42016 4.89311 3.87584 4.56542 4.38382 4.34104
         C4.89179 4.11667 5.44091 4.00052 5.99623 4
         H11.9962
         C12.9668 3.99045 13.9078 4.33416 14.6438 4.96707
         C15.3797 5.59997 15.8604 6.47889 15.9962 7.44
         C16.2495 9.36013 16.7191 11.2455 17.3962 13.06
         C17.6653 13.7758 17.7236 14.5538 17.564 15.3018
         C17.4045 16.0497 17.034 16.7362 16.4962 17.28
         L13.9562 19.82
         C16.8033 24.8271 20.9491 28.9729 25.9562 31.82
         L28.4962 29.28
         C29.04 28.7423 29.7265 28.3717 30.4745 28.2122
         C31.2224 28.0527 32.0004 28.1109 32.7162 28.38
         C34.5308 29.0571 36.4161 29.5268 38.3362 29.78
         C39.3078 29.9171 40.195 30.4064 40.8293 31.155
         C41.4636 31.9036 41.8006 32.8592 41.7762 33.84Z" stroke="currentColor" stroke-width="3.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>

                    <span>Call</span>
                </button>

                <!-- Like -->
                <button class="tool-btn tool-like-btn">
                    <!-- Like SVG -->
                    <svg class="tool-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M41.68 9.21999
         C40.6585 8.198 39.4456 7.38728 38.1107 6.83416
         C36.7758 6.28103 35.345 5.99634 33.9 5.99634
         C32.455 5.99634 31.0242 6.28103 29.6893 6.83416
         C28.3544 7.38728 27.1415 8.198 26.12 9.21999
         L24 11.34
         L21.88 9.21999
         C19.8166 7.15661 17.0181 5.99741 14.1 5.99741
         C11.1819 5.99741 8.38338 7.15661 6.31999 9.21999
         C4.25661 11.2834 3.09741 14.0819 3.09741 17
         C3.09741 19.9181 4.25661 22.7166 6.31999 24.78
         L24 42.46
         L41.68 24.78
         C42.702 23.7585 43.5127 22.5456 44.0658 21.2107
         C44.6189 19.8758 44.9036 18.445 44.9036 17
         C44.9036 15.555 44.6189 14.1242 44.0658 12.7893
         C43.5127 11.4544 42.702 10.2415 41.68 9.21999Z" stroke="currentColor" stroke-width="3.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>

                    <span>Like</span>
                </button>

            </div>
        </div>

        <!-- å¥½å‹é¢æ¿ -->
        <div class="friends-panel" id="friendsPanel">
            <div class="friends-header">
                <h2>å¥½å‹</h2>
                <button class="close-friends">âœ•</button>
            </div>

            <div class="friend-list" id="friendList">
                <!-- å¥½å‹åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button class="capsule-btn" id="addFriendHeaderBtn">æ·»åŠ å¥½å‹</button>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2>è®¾ç½®</h2>
                <button class="close-settings">âœ•</button>
            </div>

            <div class="settings-content">
                <!-- å­˜å‚¨ä¿¡æ¯ -->
                <div class="storage-info" id="storageInfo">
                    å­˜å‚¨ä½¿ç”¨æƒ…å†µ: è®¡ç®—ä¸­...
                </div>

                <div class="indexeddb-status" id="indexeddbStatus">
                    IndexedDBçŠ¶æ€: æ£€æŸ¥ä¸­...
                </div>

                <!-- è§’è‰²ä¿¡æ¯é…è‰²æ–¹æ¡ˆ -->
                <div class="setting-section">
                    <h3>è§’è‰²ä¿¡æ¯é…è‰²æ–¹æ¡ˆ</h3>
                    <div class="theme-toggle-container">
                        <span class="theme-toggle-label">é€‰æ‹©é…è‰²æ–¹æ¡ˆ</span>
                        <div class="theme-toggle-buttons">
                            <button class="theme-btn" id="lightThemeBtn">æµ…è‰²</button>
                            <button class="theme-btn" id="darkThemeBtn">æ·±è‰²</button>
                        </div>
                    </div>
                    <div class="toggle-description">
                        ä»…æ”¹å˜è§’è‰²ä¿¡æ¯ï¼ˆåç§°+çŠ¶æ€æ ï¼‰å’Œè®¾ç½®æ ‡è¯†çš„é¢œè‰²
                    </div>
                </div>

                <!-- å­˜å‚¨ä¼˜åŒ– -->
                <div class="setting-section">
                    <h3>å­˜å‚¨ä¼˜åŒ–</h3>
                    <button class="capsule-btn" id="clearOldMessagesBtn">æ¸…ç†æ—§æ¶ˆæ¯</button>
                    <div class="optimization-info" id="optimizationInfo">
                        å½“å‰ä½¿ç”¨IndexedDBå­˜å‚¨ï¼Œå®¹é‡æ— é™åˆ¶
                    </div>
                </div>

                <!-- ç”¨æˆ·åç§° -->
                <div class="setting-section">
                    <h3>ç”¨æˆ·åç§°</h3>
                    <input type="text" class="glass-input" id="userNameInput" placeholder="è¾“å…¥æ‚¨çš„åç§°">
                </div>

                <!-- å¯¹æ–¹åç§° -->
                <div class="setting-section">
                    <h3>å¯¹æ–¹åç§°</h3>
                    <input type="text" class="glass-input" id="botNameInput" placeholder="è¾“å…¥å¯¹æ–¹åç§°">
                </div>

                <!-- è§’è‰²å¤´åƒè®¾ç½® -->
                <div class="setting-section">
                    <h3>è§’è‰²å¤´åƒè®¾ç½®</h3>
                    <div class="avatar-preview">
                        <div class="avatar-wrapper avatar-lg">
                            <div class="avatar" id="avatarPreview"></div>
                        </div>
                    </div>
                    <div class="file-input-container">
                        <input type="file" id="avatarFileInput" class="hidden-file-input" accept="image/*">
                        <button class="capsule-btn" id="uploadAvatarBtn">ä»æœ¬åœ°å¯¼å…¥å¤´åƒ</button>
                    </div>
                    <div class="compression-info">
                        å¤´åƒå°†è‡ªåŠ¨è£å‰ªä¸ºæ­£æ–¹å½¢å¹¶ä»¥é«˜æ¸…å°ºå¯¸ä¿å­˜
                    </div>
                </div>

                <!-- ç”¨æˆ·å¤´åƒè®¾ç½® -->
                <div class="setting-section">
                    <h3>ç”¨æˆ·å¤´åƒè®¾ç½®</h3>

                    <div class="avatar-preview">
                        <div class="avatar-wrapper avatar-lg">
                            <div class="avatar" id="userAvatarPreview"></div>
                        </div>
                    </div>

                    <div class="file-input-container">
                        <input type="file" id="userAvatarFileInput" class="hidden-file-input" accept="image/*">
                        <button class="capsule-btn" id="uploadUserAvatarBtn">ä»æœ¬åœ°å¯¼å…¥å¤´åƒ</button>
                    </div>

                    <div class="compression-info">
                        å¤´åƒå°†è‡ªåŠ¨è£å‰ªä¸ºæ­£æ–¹å½¢å¹¶ä»¥é«˜æ¸…å°ºå¯¸ä¿å­˜
                    </div>
                </div>

                <!-- èŠå¤©èƒŒæ™¯è®¾ç½® -->
                <div class="setting-section">
                    <h3>èŠå¤©èƒŒæ™¯è®¾ç½®</h3>
                    <div class="toggle-container">
                        <span class="toggle-label">ä½¿ç”¨è‡ªå®šä¹‰èƒŒæ™¯</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="useCustomBackgroundToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        å¼€å¯åï¼Œå°†ä½¿ç”¨æ‚¨ä¸Šä¼ çš„èƒŒæ™¯å›¾ç‰‡ï¼›å…³é—­åï¼Œå°†ä½¿ç”¨é»˜è®¤æ³¢ç‚¹èƒŒæ™¯
                    </div>

                    <div class="file-input-container" style="margin-top: 15px;">
                        <input type="file" id="chatBackgroundFileInput" class="hidden-file-input" accept="image/*">
                        <button class="capsule-btn" id="uploadChatBackgroundBtn">ä»æœ¬åœ°å¯¼å…¥èƒŒæ™¯</button>
                    </div>
                    <div class="compression-info">
                        èƒŒæ™¯å›¾ç‰‡å°†è‡ªåŠ¨å‹ç¼©ä»¥é€‚åº”å±å¹•ï¼Œä¸ä¼šå˜å½¢
                    </div>
                    <div class="background-preview" id="backgroundPreview">
                        <!-- èƒŒæ™¯é¢„è§ˆ -->
                    </div>
                </div>

                <!-- ä¸»åŠ¨å‘é€æ¶ˆæ¯å¼€å…³ -->
                <div class="setting-section">
                    <h3>ä¸»åŠ¨å‘é€æ¶ˆæ¯è®¾ç½®</h3>
                    <div class="toggle-container">
                        <span class="toggle-label">å¼€å¯ä¸»åŠ¨å‘é€æ¶ˆæ¯</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="activeSendingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        å¼€å¯åï¼Œå¯¹æ–¹ä¼šåœ¨2-10åˆ†é’Ÿå†…éšæœºæ—¶é—´å‘é€æ¶ˆæ¯ï¼ˆä»å­—å¡ã€è¡¨æƒ…åŒ…ä¸­éšæœºé€‰æ‹©ï¼‰
                    </div>
                </div>

                <!-- å¼•ç”¨æ¶ˆæ¯å›å¤å¼€å…³ -->
                <div class="setting-section">
                    <h3>å¼•ç”¨æ¶ˆæ¯å›å¤è®¾ç½®</h3>
                    <div class="toggle-container">
                        <span class="toggle-label">å¼€å¯å¼•ç”¨æ¶ˆæ¯å›å¤</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="quoteReplyToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        å¼€å¯åï¼Œå¯¹æ–¹å›å¤æ—¶å¯èƒ½ä¼šå¼•ç”¨æ‚¨ä¹‹å‰å‘é€çš„æ¶ˆæ¯è¿›è¡Œå›å¤
                    </div>
                </div>

                <!-- æ‰¹é‡å›å¤è®¾ç½® -->
                <div class="setting-section">
                    <h3>æ‰¹é‡å›å¤è®¾ç½®</h3>
                    <div class="toggle-container">
                        <span class="toggle-label">å¼€å¯æ‰¹é‡å›å¤</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="multiMessageToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        å¼€å¯åï¼Œå¯¹æ–¹æ¯æ¬¡ä¼šå›å¤1-5æ¡éšæœºæ¶ˆæ¯ï¼›å…³é—­åï¼Œå¯¹æ–¹æ¯æ¬¡åªå›å¤1æ¡æ¶ˆæ¯ã€‚
                    </div>
                </div>

                <!-- èŠå¤©è®°å½•ç®¡ç† -->
                <div class="setting-section">
                    <h3>èŠå¤©è®°å½•ç®¡ç†</h3>
                    <div class="button-group">
                        <button class="capsule-btn" id="clearHistoryBtn">æ¸…é™¤èŠå¤©è®°å½•</button>
                        <button class="capsule-btn" id="exportHistoryBtn">å¯¼å‡ºèŠå¤©è®°å½•</button>
                    </div>
                </div>

                <!-- å­—å¡è®¾ç½® -->
                <div class="setting-section">
                    <h3>å­—å¡è®¾ç½®</h3>
                    <div class="add-item">
                        <input type="text" class="glass-input" id="newPhrase" placeholder="ç‚¹å‡»è¾“å…¥å­—å¡ï¼ˆæ”¯æŒæ‰¹é‡æ·»åŠ ï¼‰" readonly>
                        <button class="capsule-btn" id="morePhraseBtn">æ›´å¤š</button>
                    </div>
                    <div class="item-list" id="phraseList">
                        <!-- å­—å¡åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å¯¹æ–¹è¡¨æƒ…åŒ…è®¾ç½® -->
                <div class="setting-section">
                    <h3>å¯¹æ–¹è¡¨æƒ…åŒ…è®¾ç½®</h3>
                    <div class="file-input-container">
                        <input type="file" id="stickerFile" class="hidden-file-input" accept="image/*" multiple>
                        <button class="capsule-btn" id="uploadStickerBtn">ä»æœ¬åœ°å¯¼å…¥è¡¨æƒ…åŒ…</button>
                    </div>
                    <div class="compression-info">
                        è¡¨æƒ…åŒ…å°†è‡ªåŠ¨å‹ç¼©ä»¥èŠ‚çœç©ºé—´ï¼Œå‹ç¼©è´¨é‡: 80%
                    </div>
                    <div class="compression-progress">
                        <div class="compression-progress-bar" id="compressionProgress"></div>
                    </div>
                    <div class="sticker-grid" id="stickerList">
                        <!-- è¡¨æƒ…åŒ…åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç”¨æˆ·è¡¨æƒ…åŒ…è®¾ç½® -->
                <div class="setting-section">
                    <h3>ç”¨æˆ·è¡¨æƒ…åŒ…è®¾ç½®</h3>
                    <div class="file-input-container">
                        <input type="file" id="userStickerFile" class="hidden-file-input" accept="image/*" multiple>
                        <button class="capsule-btn" id="uploadUserStickerBtn">ä»æœ¬åœ°å¯¼å…¥è¡¨æƒ…åŒ…</button>
                    </div>
                    <div class="compression-info">
                        è¡¨æƒ…åŒ…å°†è‡ªåŠ¨å‹ç¼©ä»¥èŠ‚çœç©ºé—´ï¼Œå‹ç¼©è´¨é‡: 80%
                    </div>
                    <div class="compression-progress">
                        <div class="compression-progress-bar" id="userCompressionProgress"></div>
                    </div>
                    <div class="sticker-grid" id="userStickerList">
                        <!-- ç”¨æˆ·è¡¨æƒ…åŒ…åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ å¥½å‹å¼¹çª— -->
        <div class="add-friend-popup" id="addFriendPopup">
            <h3>æ·»åŠ å¥½å‹</h3>
            <input type="text" class="glass-input" id="newFriendName" placeholder="è¾“å…¥å¥½å‹åç§°">
            <div class="add-friend-popup-buttons">
                <button class="capsule-btn cancel" id="cancelAddFriendBtn">å–æ¶ˆ</button>
                <button class="capsule-btn" id="addFriendBtn">æ·»åŠ </button>
            </div>
        </div>

        <!-- æ‰¹é‡å­—å¡è¾“å…¥å¼¹çª— -->
        <div class="batch-phrase-popup" id="batchPhrasePopup">
            <h3>æ‰¹é‡æ·»åŠ å­—å¡</h3>
            <textarea class="batch-phrase-textarea" id="batchPhraseTextarea"
                placeholder="è¯·è¾“å…¥å­—å¡å†…å®¹ï¼Œæ¯è¡Œä¸€ä¸ªå­—å¡&#10;ä¾‹å¦‚ï¼š&#10;ä½ å¥½ï¼&#10;ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ&#10;æœ‰ä»€ä¹ˆæ–°é²œäº‹å—ï¼Ÿ"></textarea>
            <div class="batch-phrase-tip">æç¤ºï¼šæ¯è¡Œè¾“å…¥ä¸€ä¸ªå­—å¡å†…å®¹ï¼Œæ”¯æŒä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ªå­—å¡</div>
            <div class="batch-phrase-popup-buttons">
                <button class="capsule-btn cancel" id="cancelBatchPhraseBtn">å–æ¶ˆ</button>
                <button class="capsule-btn" id="confirmBatchPhraseBtn">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>

        <!-- æ–°å¢ï¼šå­—å¡ç®¡ç†å¼¹çª— - é‡æ–°è®¾è®¡ -->
        <div class="phrase-more-popup" id="phraseMorePopup">
            <h3>å­—å¡ç®¡ç†</h3>
            <div class="phrase-more-content">
                <!-- åˆ é™¤æ‰€æœ‰å­—å¡æŒ‰é’® -->
                <button class="phrase-delete-all-btn" id="deleteAllPhrasesBtn">åˆ é™¤æ‰€æœ‰å­—å¡</button>

                <!-- æœç´¢å­—å¡åŒºåŸŸ -->
                <div class="phrase-search-section">
                    <div class="phrase-search-input-container">
                        <input type="text" class="phrase-search-input" id="phraseSearchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢å­—å¡">
                        <button class="phrase-search-btn" id="searchPhraseBtn">æœç´¢</button>
                    </div>
                    <div class="search-results-title">ç›¸å…³å­—å¡é¢„è§ˆ</div>
                    <div class="phrase-search-results" id="phraseSearchResults">
                        <!-- æœç´¢ç»“æœä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å…³é—­æŒ‰é’® -->
                <button class="close-phrase-more-popup-btn" id="closePhraseMorePopupBtn">å…³é—­</button>
            </div>
        </div>

        <div class="confirm-dialog" id="confirmDialog">
            <div class="confirm-content">
                <div class="confirm-title" id="confirmTitle">ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ</div>
                <div class="confirm-buttons">
                    <button class="confirm-btn confirm-yes" id="confirmYes">ç¡®å®š</button>
                    <button class="confirm-btn confirm-no" id="confirmNo">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-text">æ­£åœ¨å‹ç¼©è¡¨æƒ…åŒ…...</div>
        </div>

        <div class="export-textarea" id="exportTextarea">
            <h3>èŠå¤©è®°å½•å¯¼å‡º</h3>
            <textarea id="exportText" readonly></textarea>
            <div class="export-textarea-buttons">
                <button class="export-textarea-btn copy-btn" id="copyExportBtn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                <button class="export-textarea-btn close-export-btn" id="closeExportBtn">å…³é—­</button>
            </div>
        </div>

        <div class="export-success" id="exportSuccess">
            èŠå¤©è®°å½•å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼
        </div>

        <div class="copy-success" id="copySuccess">
            æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼
        </div>

        <!-- æ¶ˆæ¯æ“ä½œèœå• -->
        <div class="message-action-menu" id="messageActionMenu">
            <button class="action-menu-item" id="copyMessageBtn">å¤åˆ¶</button>
        </div>
    </div>

    <!-- JavaScript ä»£ç  -->
    <script>

        // ==========================
        // Voice Record Global State
        // ==========================
        let lastRenderedDate = null;
        //let mediaRecorder = null;
        //let audioChunks = [];
        //let recordStartTime = 0;
        //let recordStream = null; // âœ… æ–°å¢ï¼šä¿å­˜ stream
        //let isRecording = false;

        // åˆå§‹åŒ–æ•°æ®
        let appData = {
            currentFriendId: "friend1",
            userName: "ç”¨æˆ·",
            userAvatarImage: null,   // â­ æ–°å¢ï¼šç”¨æˆ·å¤´åƒ
            userStickers: [],
            friends: {
                "friend1": {
                    id: "friend1",
                    name: "èŠå¤©ä¼™ä¼´",
                    avatar: "å‹",
                    avatarImage: null,
                    backgroundImage: null,
                    useCustomBackground: false,
                    theme: "light",
                    messages: [],
                    unreadCount: 0,
                    settings: {
                        multiMessageEnabled: true,
                        activeSending: false,
                        enableQuoteReply: true,
                        phrases: ["ä½ å¥½ï¼", "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ‰ä»€ä¹ˆæ–°é²œäº‹å—ï¼Ÿ", "å¾ˆé«˜å…´å’Œä½ èŠå¤©ï¼", "æœ€è¿‘åœ¨å¿™ä»€ä¹ˆï¼Ÿ"],
                        stickers: []
                    }
                }
            }
        };

        // DOMå…ƒç´  - ä¿æŒä¸å˜...
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        // const voiceBtn = document.getElementById('voiceBtn'); // ğŸ‘ˆ å°±åŠ åœ¨è¿™ä¸€å †é‡Œ
        const settingsBtn = document.querySelector('.settings-btn');
        const settingsPanel = document.getElementById('settingsPanel');
        const closeSettings = document.querySelector('.close-settings');
        const stickerBtn = document.querySelector('.tool-sticker-btn');
        const imageBtn = document.querySelector('.tool-image-btn');
        const stickerPicker = document.getElementById('stickerPicker');
        const imageFileInput = document.getElementById('imageFileInput');
        const botNameElement = document.getElementById('botName');
        const botAvatar = document.getElementById('botAvatar');
        const botNameInput = document.getElementById('botNameInput');
        const userNameInput = document.getElementById('userNameInput');
        const multiMessageToggle = document.getElementById('multiMessageToggle');
        const activeSendingToggle = document.getElementById('activeSendingToggle');
        const quoteReplyToggle = document.getElementById('quoteReplyToggle');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        const compressionProgress = document.getElementById('compressionProgress');
        const userCompressionProgress = document.getElementById('userCompressionProgress');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const chatStatus = document.getElementById('chatStatus');
        const storageInfo = document.getElementById('storageInfo');
        const exportTextarea = document.getElementById('exportTextarea');
        const exportText = document.getElementById('exportText');
        const copyExportBtn = document.getElementById('copyExportBtn');
        const closeExportBtn = document.getElementById('closeExportBtn');
        const exportSuccess = document.getElementById('exportSuccess');
        const copySuccess = document.getElementById('copySuccess');


        // å¥½å‹ç›¸å…³DOMå…ƒç´ 
        const avatarContainer = document.getElementById('avatarContainer');
        const friendsPanel = document.getElementById('friendsPanel');
        const addFriendHeaderBtn = document.getElementById('addFriendHeaderBtn');
        const addFriendPopup = document.getElementById('addFriendPopup');
        const newFriendName = document.getElementById('newFriendName');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const cancelAddFriendBtn = document.getElementById('cancelAddFriendBtn');
        const friendList = document.getElementById('friendList');
        const closeFriends = document.querySelector('.close-friends');

        // è®¾ç½®ç›¸å…³å…ƒç´ 
        const newPhrase = document.getElementById('newPhrase');
        const morePhraseBtn = document.getElementById('morePhraseBtn');
        const phraseList = document.getElementById('phraseList');
        const stickerFile = document.getElementById('stickerFile');
        const stickerList = document.getElementById('stickerList');
        const userStickerFile = document.getElementById('userStickerFile');
        const userStickerList = document.getElementById('userStickerList');

        // å­˜å‚¨ä¼˜åŒ–ç›¸å…³å…ƒç´ 
        const clearOldMessagesBtn = document.getElementById('clearOldMessagesBtn');
        const optimizationInfo = document.getElementById('optimizationInfo');
        const indexeddbStatus = document.getElementById('indexeddbStatus');

        // æ¶ˆæ¯æ“ä½œèœå•ç›¸å…³å…ƒç´ 
        const messageActionMenu = document.getElementById('messageActionMenu');
        const copyMessageBtn = document.getElementById('copyMessageBtn');

        // å½“å‰é€‰ä¸­çš„æ¶ˆæ¯
        let currentSelectedMessage = null;

        // å¤´åƒè®¾ç½®ç›¸å…³å…ƒç´ 
        const avatarFileInput = document.getElementById('avatarFileInput');
        const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
        const avatarPreview = document.getElementById('avatarPreview');

        // ç”¨æˆ·å¤´åƒç›¸å…³å…ƒç´ 
        const userAvatarFileInput = document.getElementById('userAvatarFileInput');
        const uploadUserAvatarBtn = document.getElementById('uploadUserAvatarBtn');
        const userAvatarPreview = document.getElementById('userAvatarPreview');

        // èƒŒæ™¯è®¾ç½®ç›¸å…³å…ƒç´ 
        const chatBackgroundFileInput = document.getElementById('chatBackgroundFileInput');
        const uploadChatBackgroundBtn = document.getElementById('uploadChatBackgroundBtn');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const useCustomBackgroundToggle = document.getElementById('useCustomBackgroundToggle');

        // è¡¨æƒ…åŒ…ä¸Šä¼ æŒ‰é’®
        const uploadStickerBtn = document.getElementById('uploadStickerBtn');
        const uploadUserStickerBtn = document.getElementById('uploadUserStickerBtn');

        // åˆå§‹åŠ è½½åŠ¨ç”»å…ƒç´ 
        const initialLoading = document.getElementById('initialLoading');
        const mainContainer = document.getElementById('mainContainer');

        // æ–°å¢ï¼šä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        const lightThemeBtn = document.getElementById('lightThemeBtn');
        const darkThemeBtn = document.getElementById('darkThemeBtn');

        // é®ç½©å±‚
        const overlay = document.getElementById('overlay');

        // æ–°å¢ï¼šæ‰¹é‡å­—å¡ç›¸å…³å…ƒç´ 
        const batchPhrasePopup = document.getElementById('batchPhrasePopup');
        const batchPhraseTextarea = document.getElementById('batchPhraseTextarea');
        const cancelBatchPhraseBtn = document.getElementById('cancelBatchPhraseBtn');
        const confirmBatchPhraseBtn = document.getElementById('confirmBatchPhraseBtn');

        // æ–°å¢ï¼šå­—å¡ç®¡ç†å¼¹çª—ç›¸å…³å…ƒç´ 
        const phraseMorePopup = document.getElementById('phraseMorePopup');
        const deleteAllPhrasesBtn = document.getElementById('deleteAllPhrasesBtn');
        const phraseSearchInput = document.getElementById('phraseSearchInput');
        const searchPhraseBtn = document.getElementById('searchPhraseBtn');
        const phraseSearchResults = document.getElementById('phraseSearchResults');
        const closePhraseMorePopupBtn = document.getElementById('closePhraseMorePopupBtn');

        // IndexedDBç›¸å…³å˜é‡
        let db = null;
        const DB_NAME = 'ChatAppDB';
        const DB_VERSION = 5; // ä¿æŒç‰ˆæœ¬å·ä¸å˜
        const STORE_NAME = 'appData';

        // æ–°å¢ï¼šä¸´æ—¶çŠ¶æ€å˜é‡ï¼ˆä¸ä¿å­˜åˆ°IndexedDBï¼‰
        let replyTaskQueues = {}; // å„å¥½å‹çš„å›å¤ä»»åŠ¡é˜Ÿåˆ—
        let activeSendingTimers = {}; // å„å¥½å‹çš„ä¸»åŠ¨å‘é€å®šæ—¶å™¨
        let isProcessingQueues = {}; // å„å¥½å‹çš„é˜Ÿåˆ—å¤„ç†çŠ¶æ€

        // åˆå§‹åŒ–IndexedDB
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject(new Error("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒIndexedDB"));
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = function (event) {
                    console.error("IndexedDBæ‰“å¼€å¤±è´¥:", event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = function (event) {
                    db = event.target.result;
                    console.log("IndexedDBæ‰“å¼€æˆåŠŸ");
                    indexeddbStatus.textContent = "IndexedDBçŠ¶æ€: å·²è¿æ¥";
                    indexeddbStatus.className = "indexeddb-status status-ok";
                    resolve(db);
                };

                request.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        console.log("åˆ›å»ºå¯¹è±¡å­˜å‚¨:", STORE_NAME);
                    }
                };
            });
        }

        // ä»IndexedDBåŠ è½½æ•°æ®
        async function loadFromIndexedDB() {
            if (!db) {
                console.error("IndexedDBæœªåˆå§‹åŒ–");
                return null;
            }

            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('appData');

                request.onsuccess = function (event) {
                    const result = event.target.result;
                    if (result && result.data) {
                        console.log("ä»IndexedDBåŠ è½½æ•°æ®æˆåŠŸ");
                        resolve(result.data);
                    } else {
                        console.log("IndexedDBä¸­æ²¡æœ‰æ•°æ®");
                        resolve(null);
                    }
                };

                request.onerror = function (event) {
                    console.error("ä»IndexedDBåŠ è½½æ•°æ®å¤±è´¥:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // å‡†å¤‡è¦ä¿å­˜çš„æ•°æ®ï¼ˆæ¸…ç†ä¸´æ—¶çŠ¶æ€ï¼‰
        function prepareDataForSaving(data) {
            const dataToSave = JSON.parse(JSON.stringify(data));

            // ç¡®ä¿ä¸ä¿å­˜ä»»ä½•ä¸´æ—¶çŠ¶æ€
            Object.values(dataToSave.friends).forEach(friend => {
                // ç¡®ä¿settingså¯¹è±¡ä¸­ä¸åŒ…å«ä»»ä½•ä¸´æ—¶çŠ¶æ€
                if (friend.settings) {
                    // åˆ é™¤å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶çŠ¶æ€å­—æ®µ
                    delete friend.settings.replyTaskQueue;
                    delete friend.settings.isProcessingQueue;
                    delete friend.settings.queueTimer;
                    delete friend.settings.activeTimer;
                    delete friend.settings.lastActiveMessageTime;
                }
            });

            return dataToSave;
        }

        // ä¿å­˜æ•°æ®åˆ°IndexedDB
        async function saveToIndexedDB(data) {
            if (!db) {
                console.error("IndexedDBæœªåˆå§‹åŒ–");
                return false;
            }

            return new Promise((resolve, reject) => {
                try {
                    const dataToSave = prepareDataForSaving(data);

                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put({ id: 'appData', data: dataToSave });

                    request.onsuccess = function (event) {
                        console.log("æ•°æ®ä¿å­˜åˆ°IndexedDBæˆåŠŸ");
                        resolve(true);
                    };

                    request.onerror = function (event) {
                        console.error("ä¿å­˜æ•°æ®åˆ°IndexedDBå¤±è´¥:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("ä¿å­˜æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸:", error);
                    reject(error);
                }
            });
        }

        // è·å–å½“å‰å¥½å‹æ•°æ®
        function getCurrentFriend() {
            return appData.friends[appData.currentFriendId];
        }

        // ä»å­˜å‚¨åŠ è½½æ•°æ®
        async function loadData() {
            // é¦–å…ˆå°è¯•ä»IndexedDBåŠ è½½
            try {
                await initIndexedDB();
                const data = await loadFromIndexedDB();
                if (data) {
                    appData = data;
                    console.log("æ•°æ®ä»IndexedDBåŠ è½½æˆåŠŸ");

                    // åˆå§‹åŒ–ä¸´æ—¶çŠ¶æ€å˜é‡
                    initTemporaryState();

                    // åº”ç”¨å½“å‰å¥½å‹çš„ä¸»é¢˜
                    applyTheme(getCurrentFriend().theme);

                    updateStorageInfo();
                    renderFriendsList();
                    renderChat();
                    renderSettings();

                    // é‡ç½®çŠ¶æ€æ ä¸ºåœ¨çº¿
                    chatStatus.textContent = "åœ¨çº¿";

                    // é‡æ–°å¯åŠ¨æ‰€æœ‰å¥½å‹çš„ä¸»åŠ¨å‘é€ï¼ˆå¦‚æœå¼€å¯ï¼‰
                    restartAllActiveSending();

                    return;
                }
            } catch (error) {
                console.error("ä»IndexedDBåŠ è½½æ•°æ®å¤±è´¥:", error);
                indexeddbStatus.textContent = "IndexedDBçŠ¶æ€: è¿æ¥å¤±è´¥";
                indexeddbStatus.className = "indexeddb-status status-error";
            }

            // å¦‚æœIndexedDBæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
            initTemporaryState();
            updateStorageInfo();
            renderFriendsList();
            renderChat();
            renderSettings();

            // é‡ç½®çŠ¶æ€æ ä¸ºåœ¨çº¿
            chatStatus.textContent = "åœ¨çº¿";

            // å¯åŠ¨æ‰€æœ‰å¥½å‹çš„ä¸»åŠ¨å‘é€ï¼ˆå¦‚æœå¼€å¯ï¼‰
            restartAllActiveSending();
        }

        // åˆå§‹åŒ–ä¸´æ—¶çŠ¶æ€
        function initTemporaryState() {
            // åˆå§‹åŒ–å„å¥½å‹çš„ä¸´æ—¶çŠ¶æ€
            Object.keys(appData.friends).forEach(friendId => {
                replyTaskQueues[friendId] = [];
                activeSendingTimers[friendId] = null;
                isProcessingQueues[friendId] = false;

                // ç¡®ä¿å¥½å‹å¯¹è±¡æœ‰unreadCountå±æ€§
                if (!appData.friends[friendId].hasOwnProperty('unreadCount')) {
                    appData.friends[friendId].unreadCount = 0;
                }

                // ç¡®ä¿settingsä¸­æ²¡æœ‰ä¸´æ—¶çŠ¶æ€å­—æ®µ
                const friend = appData.friends[friendId];
                if (friend.settings) {
                    delete friend.settings.replyTaskQueue;
                    delete friend.settings.isProcessingQueue;
                    delete friend.settings.queueTimer;
                    delete friend.settings.activeTimer;
                    delete friend.settings.lastActiveMessageTime;
                }
            });
        }

        // é‡æ–°å¯åŠ¨æ‰€æœ‰å¥½å‹çš„ä¸»åŠ¨å‘é€
        function restartAllActiveSending() {
            Object.keys(appData.friends).forEach(friendId => {
                const friend = appData.friends[friendId];

                // å¦‚æœå¼€å¯ä¸»åŠ¨å‘é€ï¼Œé‡æ–°å®‰æ’
                if (friend.settings.activeSending) {
                    scheduleActiveMessage(friendId);
                }
            });
        }

        // ä¿å­˜æ•°æ®
        async function saveData() {
            try {
                await saveToIndexedDB(appData);
                updateStorageInfo();
                return true;
            } catch (error) {
                console.error("ä¿å­˜åˆ°IndexedDBå¤±è´¥:", error);
                return false;
            }
        }

        // æ›´æ–°å­˜å‚¨ä¿¡æ¯æ˜¾ç¤º
        function updateStorageInfo() {
            storageInfo.textContent = "å­˜å‚¨ä½¿ç”¨æƒ…å†µ: ä½¿ç”¨IndexedDBå­˜å‚¨ï¼Œå®¹é‡æ— é™åˆ¶";
            optimizationInfo.textContent = "å½“å‰ä½¿ç”¨IndexedDBå­˜å‚¨ï¼Œå®¹é‡æ— é™åˆ¶";
        }

        // æ¸…ç†æ—§æ¶ˆæ¯
        function clearOldMessages() {
            const currentFriend = getCurrentFriend();
            if (currentFriend.messages.length <= 100) {
                alert("å½“å‰æ¶ˆæ¯æ•°é‡ä¸è¶³100æ¡ï¼Œæ— éœ€æ¸…ç†");
                return;
            }

            // ä¿ç•™æœ€è¿‘100æ¡æ¶ˆæ¯
            currentFriend.messages = currentFriend.messages.slice(-100);
            saveData().then(success => {
                if (success) {
                    renderChat();
                    renderFriendsList();
                    alert("å·²æ¸…ç†æ—§æ¶ˆæ¯ï¼Œä¿ç•™æœ€è¿‘100æ¡");
                } else {
                    alert("æ¸…ç†å¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            });
        }

        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
        function renderFriendsList() {
            friendList.innerHTML = '';

            Object.values(appData.friends).forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = `friend-item ${friend.id === appData.currentFriendId ? 'active' : ''}`;

                const lastMessage = friend.messages.length > 0 ?
                    friend.messages[friend.messages.length - 1] : null;

                let lastMessageText = "è¿˜æ²¡æœ‰èŠå¤©è®°å½•";
                if (lastMessage) {
                    if (lastMessage.type === 'text') {
                        lastMessageText = lastMessage.content;
                    } else if (lastMessage.type === 'image') {
                        lastMessageText = '[å›¾ç‰‡]';
                    } else if (lastMessage.type === 'emoji') {
                        lastMessageText = lastMessage.content;
                    } else if (lastMessage.type === 'sticker') {
                        lastMessageText = '[è¡¨æƒ…åŒ…]';
                    }

                    // æˆªæ–­è¿‡é•¿çš„æ¶ˆæ¯
                    if (lastMessageText.length > 20) {
                        lastMessageText = lastMessageText.substring(0, 20) + '...';
                    }
                }

                // å¥½å‹åˆ—è¡¨æ˜¾ç¤ºå¤´åƒ
                let avatarContent = friend.avatar || friend.name.charAt(0);
                if (friend.avatarImage) {
                    avatarContent = `<img src="${friend.avatarImage}" style="width: 100%; height: 100%; border-radius: 50%;">`;
                }

                friendItem.innerHTML = `
                    <div class="friend-avatar">${avatarContent}</div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.name}</div>
                        <div class="friend-last-message">${lastMessageText}</div>
                    </div>
                `;

                // æ·»åŠ æœªè¯»æ¶ˆæ¯æç¤º
                if (friend.unreadCount > 0) {
                    const unreadBadge = document.createElement('div');
                    unreadBadge.className = 'unread-badge';
                    unreadBadge.textContent = friend.unreadCount > 99 ? '99+' : friend.unreadCount.toString();
                    friendItem.appendChild(unreadBadge);
                }

                friendItem.addEventListener('click', () => {
                    switchFriend(friend.id);
                });

                friendList.appendChild(friendItem);
            });
        }

        // åˆ‡æ¢å¥½å‹
        function switchFriend(friendId) {
            console.log("åˆ‡æ¢å¥½å‹åˆ°:", friendId);

            // åˆ‡æ¢åˆ°æ–°å¥½å‹
            appData.currentFriendId = friendId;

            // æ¸…é›¶å½“å‰å¥½å‹çš„æœªè¯»è®¡æ•°
            const currentFriend = getCurrentFriend();
            if (currentFriend.unreadCount > 0) {
                currentFriend.unreadCount = 0;
                saveData();
            }

            renderFriendsList();
            renderChat();
            renderSettings();

            // åº”ç”¨æ–°å¥½å‹çš„ä¸»é¢˜
            applyTheme(getCurrentFriend().theme);

            // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º - æ ¹æ®å½“å‰å¥½å‹çš„é˜Ÿåˆ—çŠ¶æ€
            updateChatStatusForCurrentFriend();

            // å…³é—­å¥½å‹é¢æ¿
            closePanel();
        }

        // æ›´æ–°å½“å‰å¥½å‹çš„èŠå¤©çŠ¶æ€
        function updateChatStatusForCurrentFriend() {
            const currentFriendId = appData.currentFriendId;

            // æ£€æŸ¥å½“å‰å¥½å‹æ˜¯å¦æœ‰æ­£åœ¨å¤„ç†çš„ä»»åŠ¡é˜Ÿåˆ—
            if (isProcessingQueues[currentFriendId] ||
                (replyTaskQueues[currentFriendId] && replyTaskQueues[currentFriendId].length > 0)) {
                chatStatus.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
            } else {
                chatStatus.textContent = "åœ¨çº¿";
            }
        }

        // æ·»åŠ å¥½å‹
        function addFriend(name) {
            if (!name.trim()) return;

            const friendId = 'friend' + Date.now();
            appData.friends[friendId] = {
                id: friendId,
                name: name,
                avatar: name.charAt(0),
                avatarImage: null,
                backgroundImage: null,
                useCustomBackground: false,
                theme: "light",
                messages: [],
                unreadCount: 0,
                settings: {
                    multiMessageEnabled: true,
                    activeSending: false,
                    enableQuoteReply: true,
                    phrases: ["ä½ å¥½ï¼", "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ‰ä»€ä¹ˆæ–°é²œäº‹å—ï¼Ÿ", "å¾ˆé«˜å…´å’Œä½ èŠå¤©ï¼", "æœ€è¿‘åœ¨å¿™ä»€ä¹ˆï¼Ÿ"],
                    stickers: []
                }
            };

            // åˆå§‹åŒ–æ–°å¥½å‹çš„ä¸´æ—¶çŠ¶æ€
            replyTaskQueues[friendId] = [];
            activeSendingTimers[friendId] = null;
            isProcessingQueues[friendId] = false;

            saveData();
            renderFriendsList();
            newFriendName.value = '';
            addFriendPopup.classList.remove('active');
            overlay.classList.remove('active');
        }

        // åˆ é™¤å¥½å‹
        function deleteFriend(friendId) {
            if (Object.keys(appData.friends).length <= 1) {
                alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå¥½å‹");
                return;
            }

            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼ŸèŠå¤©è®°å½•å°†æ— æ³•æ¢å¤ã€‚")) {
                // æ¸…é™¤è¯¥å¥½å‹çš„é˜Ÿåˆ—å¤„ç†å®šæ—¶å™¨
                if (activeSendingTimers[friendId]) {
                    clearTimeout(activeSendingTimers[friendId]);
                }

                // åˆ é™¤ä¸´æ—¶çŠ¶æ€
                delete replyTaskQueues[friendId];
                delete activeSendingTimers[friendId];
                delete isProcessingQueues[friendId];

                delete appData.friends[friendId];

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¥½å‹ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªå¥½å‹
                if (appData.currentFriendId === friendId) {
                    const remainingFriendIds = Object.keys(appData.friends);
                    if (remainingFriendIds.length > 0) {
                        appData.currentFriendId = remainingFriendIds[0];
                    }
                }

                saveData();
                renderFriendsList();
                renderChat();
                renderSettings();
            }
        }

        // ==========================
        // ç»Ÿä¸€æ¶ˆæ¯å†…å®¹æ¸²æŸ“ï¼ˆå”¯ä¸€å…¥å£ï¼‰
        // ==========================
        function renderMessageContent(container, msg) {
            if (msg.type === 'text') {
                container.textContent = msg.content;

            } else if (msg.type === 'image') {
                container.innerHTML =
                    `<img src="${msg.content}" style="max-width:200px;border-radius:5px;">`;

            } else if (msg.type === 'emoji') {
                container.innerHTML =
                    `<div style="font-size:13px;line-height:1.4;">${msg.content}</div>`;

            } else if (msg.type === 'sticker') {
                container.innerHTML =
                    `<img src="${msg.content}" style="max-width:100px;border-radius:5px;">`;
            }
        }


        // ==========================
        // æ„å»ºå•æ¡æ¶ˆæ¯ DOMï¼ˆå”¯ä¸€ç»“æ„ï¼‰
        // ==========================
        function renderSingleMessage(msg, index, currentFriend) {
            const fragment = document.createDocumentFragment();

            const msgDate = new Date(msg.timestamp);
            const currentDate = msgDate.toDateString();
            const currentTime = msgDate.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            // ===== æ—¶é—´åˆ†å‰²çº¿ï¼ˆåªåœ¨éœ€è¦æ—¶æ’å…¥ï¼‰=====
            if (
                index === 0 ||
                timeDifferenceInMinutes(
                    msg.timestamp,
                    currentFriend.messages[index - 1].timestamp
                ) >= 30
            ) {
                const timeDivider = document.createElement('div');
                timeDivider.className = 'time-divider';

                const dateText = formatDate(msg.timestamp, lastRenderedDate);

                let text;
                if (dateText) {
                    text = `${dateText} ${currentTime}`;
                    lastRenderedDate = msg.timestamp; // â­ åªæœ‰æ˜¾ç¤ºäº†æ—¥æœŸæ‰æ›´æ–°
                } else {
                    text = currentTime;
                }

                timeDivider.innerHTML = `<span>${text}</span>`;
                fragment.appendChild(timeDivider);
            }

            // 1ï¸âƒ£ åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const messageContainer = document.createElement('div');
            messageContainer.className =
                `message-container ${msg.sender}-container`;

            /*// ===== å¤´åƒåˆå¹¶åˆ¤æ–­ =====
            let showAvatar = true;

            if (index > 0) {
                const prevMsg = currentFriend.messages[index - 1];
                if (prevMsg.sender === msg.sender) {
                    showAvatar = false;
                }
            } 

            // 2ï¸âƒ£ åˆ›å»ºå¤´åƒ
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${msg.sender}-avatar`;

            if (showAvatar) {
                if (msg.sender === 'user') {
                    if (appData.userAvatarImage) {
                        const img = document.createElement('img');
                        img.src = appData.userAvatarImage;
                        avatarDiv.appendChild(img);
                    } else {
                        avatarDiv.textContent = appData.userName.charAt(0);
                    }
                } else {
                    if (currentFriend.avatarImage) {
                        const img = document.createElement('img');
                        img.src = currentFriend.avatarImage;
                        avatarDiv.appendChild(img);
                    } else {
                        avatarDiv.textContent =
                            currentFriend.avatar || currentFriend.name.charAt(0);
                    }
                }
            } else {
                // â­ å…³é”®ï¼šéšè—å¤´åƒä½†ä¿ç•™å ä½
                avatarDiv.style.visibility = 'hidden';
            } */

            // 2ï¸âƒ£ åˆ›å»ºå¤´åƒ
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${msg.sender}-avatar`;

            if (msg.sender === 'user') {
                if (appData.userAvatarImage) {
                    const img = document.createElement('img');
                    img.src = appData.userAvatarImage;
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = appData.userName.charAt(0);
                }
            } else {
                if (currentFriend.avatarImage) {
                    const img = document.createElement('img');
                    img.src = currentFriend.avatarImage;
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent =
                        currentFriend.avatar || currentFriend.name.charAt(0);
                }
            }

            // 3ï¸âƒ£ åˆ›å»º messageDivï¼ˆæ°”æ³¡ï¼‰
            const messageDiv = document.createElement('div');

            // 4ï¸âƒ£ åˆ¤æ–­æ˜¯å¦æ— æ°”æ³¡
            const isNoBubble =
                msg.type === 'image' ||
                msg.type === 'sticker';

            // 5ï¸âƒ£ è®¾ç½®æ°”æ³¡ class
            messageDiv.className =
                `message ${msg.sender}-message` +
                (isNoBubble ? ' no-bubble' : '');

            messageDiv.setAttribute('data-message-id', index);

            // ===== æœ‰å¼•ç”¨ =====
            if (msg.quote) {
                const messageWithQuote = document.createElement('div');
                messageWithQuote.className = 'message-with-quote';

                const quotedContent = document.createElement('div');
                quotedContent.className = 'quoted-content';

                const quoteSender = document.createElement('div');
                quoteSender.className = 'quote-sender';
                quoteSender.textContent =
                    msg.quoteSender ||
                    (msg.sender === 'user'
                        ? appData.userName
                        : currentFriend.name);

                const quoteText = document.createElement('div');
                quoteText.className = 'quoted-text';

                if (msg.quoteType === 'image' || msg.quoteType === 'sticker') {
                    const img = document.createElement('img');
                    img.src = msg.quote;
                    img.className = 'quoted-image';
                    quoteText.appendChild(img);
                } else {
                    quoteText.textContent =
                        msg.quote.length > 50
                            ? msg.quote.substring(0, 50) + '...'
                            : msg.quote;
                }

                const mainContent = document.createElement('div');
                mainContent.className = 'main-content';
                renderMessageContent(mainContent, msg);

                quotedContent.appendChild(quoteSender);
                quotedContent.appendChild(quoteText);
                messageWithQuote.appendChild(quotedContent);
                messageWithQuote.appendChild(mainContent);
                messageDiv.appendChild(messageWithQuote);

            } else {
                // ===== æ— å¼•ç”¨ =====
                renderMessageContent(messageDiv, msg);
            }

            messageDiv.addEventListener('click', handleMessageClick);

            // 6ï¸âƒ£ æŒ‰ sender ç»„åˆé¡ºåº
            if (msg.sender === 'user') {
                messageContainer.appendChild(messageDiv);
                messageContainer.appendChild(avatarDiv);
            } else {
                messageContainer.appendChild(avatarDiv);
                messageContainer.appendChild(messageDiv);
            }

            fragment.appendChild(messageContainer);
            return fragment;
        }

        // ==========================
        // å…¨é‡æ¸²æŸ“ï¼ˆåªåœ¨åˆå§‹åŒ– / åˆ‡æ¢æ—¶ç”¨ï¼‰
        // ==========================
        function renderChat() {
            chatArea.innerHTML = '';
            lastRenderedDate = null; // â­ æ–°å¢ï¼šé‡ç½®æ—¥æœŸé”šç‚¹
            const currentFriend = getCurrentFriend();


            // èƒŒæ™¯å¤„ç†
            const chatBg = document.getElementById('chatBg');
            chatBg.style.backgroundImage = '';
            chatBg.style.backgroundColor = '';

            if (currentFriend.useCustomBackground && currentFriend.backgroundImage) {
                chatBg.style.backgroundImage = `url(${currentFriend.backgroundImage})`;
                chatBg.style.backgroundSize = 'cover';
                chatBg.style.backgroundPosition = 'center';
                chatBg.style.backgroundRepeat = 'no-repeat';
            } else {
                chatBg.style.backgroundImage = 'none';
                chatBg.style.backgroundColor = '#f2f2f2';
            }

            currentFriend.messages.forEach((msg, index) => {
                const node = renderSingleMessage(msg, index, currentFriend);
                chatArea.appendChild(node);
            });

            // å…¨é‡æ¸²æŸ“å®Œï¼Œç›´æ¥æ»šåˆ°åº•
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ç‚¹å‡»æ¶ˆæ¯äº‹ä»¶å¤„ç†
        function handleMessageClick(e) {
            const messageDiv = e.currentTarget;
            const messageId = parseInt(messageDiv.getAttribute('data-message-id'));
            const currentFriend = getCurrentFriend();
            const message = currentFriend.messages[messageId];

            // ä¿å­˜å½“å‰æ¶ˆæ¯ä¿¡æ¯
            currentSelectedMessage = {
                id: messageId,
                sender: message.sender === 'user' ? appData.userName : currentFriend.name,
                content: message.content
            };

            // è·å–æ¶ˆæ¯å…ƒç´ ä½ç½®
            const rect = messageDiv.getBoundingClientRect();

            // è®¾ç½®èœå•ä½ç½®
            messageActionMenu.style.top = `${rect.top - 35}px`;
            messageActionMenu.style.left = `${rect.left}px`;
            messageActionMenu.style.display = 'flex';

            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            e.stopPropagation();
        }

        // è®¡ç®—æ—¶é—´å·®ï¼ˆåˆ†é’Ÿï¼‰â€”â€”ä¿æŒä¸å˜
        function timeDifferenceInMinutes(timestamp1, timestamp2) {
            return Math.abs(timestamp1 - timestamp2) / (1000 * 60);
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        // è§„åˆ™ï¼š
        // 1. æ–°çš„ä¸€å¤©ä¸€å®šæ˜¾ç¤º
        // 2. åŒä¸€å¹´åªæ˜¾ç¤ºã€Œæœˆæ—¥ã€
        // 3. è·¨å¹´æ‰æ˜¾ç¤ºã€Œå¹´æœˆæ—¥ã€
        function formatDate(timestamp, lastTimestamp) {
            const date = new Date(timestamp);

            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            // æ²¡æœ‰ä¸Šä¸€æ¡æ—¶é—´ï¼ˆä¼šè¯èµ·ç‚¹ï¼‰â†’ æ˜¾ç¤ºå®Œæ•´å¹´æœˆæ—¥
            if (!lastTimestamp) {
                return `${year}å¹´${month}æœˆ${day}æ—¥`;
            }

            const lastDate = new Date(lastTimestamp);

            // åˆ¤æ–­æ˜¯å¦æ–°çš„ä¸€å¤©
            const isNewDay =
                year !== lastDate.getFullYear() ||
                date.getMonth() !== lastDate.getMonth() ||
                day !== lastDate.getDate();

            // ä¸æ˜¯æ–°çš„ä¸€å¤© â†’ ä¸æ˜¾ç¤ºæ—¥æœŸ
            if (!isNewDay) {
                return null;
            }

            // æ–°çš„ä¸€å¤©ï¼Œä½†åŒä¸€å¹´ â†’ åªæ˜¾ç¤º æœˆæ—¥
            if (year === lastDate.getFullYear()) {
                return `${month}æœˆ${day}æ—¥`;
            }

            // è·¨å¹´ â†’ æ˜¾ç¤º å¹´æœˆæ—¥
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        //toolå¼¹çª—ã€‚
        const panel = document.getElementById("tool-panel");
        const dragHandle = document.getElementById("toolPanelDrag");
        const toggleBtn = document.getElementById("toolToggle");

        /* æ˜¾ç¤º / éšè— */
        toggleBtn.addEventListener("click", () => {
            panel.classList.toggle("hidden");
        });

        /* ===== ä»…å¤´éƒ¨æ‹–æ‹½ ===== */

        let isDragging = false;
        let startX = 0;
        let startY = 0;

        dragHandle.addEventListener("pointerdown", (e) => {
            isDragging = true;

            // ç”¨çœŸå®è§†è§‰ä½ç½®è®¡ç®—ï¼ˆä¸è¦ç”¨ offsetLeft çš„æ—§å€¼ï¼‰
            const rect = panel.getBoundingClientRect();

            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;

            // â­ æ ¸å¿ƒä¿®å¤ï¼šä» bottom å®šä½ â†’ top/left å®šä½
            panel.style.left = rect.left + "px";
            panel.style.top = rect.top + "px";
            panel.style.bottom = "auto";      // âœ… å¿…é¡»æ¸…æ‰ï¼Œä¸ç„¶ä¼šæ‹‰ä¼¸é«˜åº¦
            panel.style.transform = "none";   // âœ… æ¸…æ‰ translateX(-50%)

            dragHandle.setPointerCapture(e.pointerId);

            panel.style.cursor = "grabbing";
        });

        dragHandle.addEventListener("pointermove", (e) => {
            if (!isDragging) return;

            panel.style.left = `${e.clientX - startX}px`;
            panel.style.top = `${e.clientY - startY}px`;
        });

        dragHandle.addEventListener("pointerup", () => {
            isDragging = false;
            panel.style.cursor = "default";
        });

        dragHandle.addEventListener("pointercancel", () => {
            isDragging = false;
        });

        // æ¸²æŸ“è®¾ç½®ç•Œé¢
        function renderSettings() {
            const currentFriend = getCurrentFriend();

            botNameElement.textContent = currentFriend.name;

            // æ›´æ–°å¤´åƒæ˜¾ç¤º
            if (currentFriend.avatarImage) {
                botAvatar.innerHTML = `<img src="${currentFriend.avatarImage}" style="width: 100%; height: 100%; border-radius: 50%;">`;
            } else {
                botAvatar.textContent = currentFriend.avatar || currentFriend.name.charAt(0);
            }

            botNameInput.value = currentFriend.name;
            userNameInput.value = appData.userName;
            multiMessageToggle.checked = currentFriend.settings.multiMessageEnabled;
            activeSendingToggle.checked = currentFriend.settings.activeSending;
            quoteReplyToggle.checked = currentFriend.settings.enableQuoteReply;
            useCustomBackgroundToggle.checked = currentFriend.useCustomBackground;

            // æ›´æ–°å¤´åƒé¢„è§ˆ
            if (currentFriend.avatarImage) {
                avatarPreview.innerHTML = `<img src="${currentFriend.avatarImage}" style="width: 100%; height: 100%; border-radius: 50%;">`;
            } else {
                avatarPreview.textContent = currentFriend.avatar || currentFriend.name.charAt(0);
            }

            // ===== ç”¨æˆ·å¤´åƒé¢„è§ˆï¼ˆå¼ºåˆ¶æ¸…ç©ºæ³•ï¼‰=====
            userAvatarPreview.innerHTML = '';
            userAvatarPreview.textContent = '';

            if (appData.userAvatarImage) {
                const img = document.createElement('img');
                img.src = appData.userAvatarImage;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';

                userAvatarPreview.appendChild(img);
            } else {
                userAvatarPreview.textContent = appData.userName.charAt(0);
            }

            // æ›´æ–°èƒŒæ™¯é¢„è§ˆ
            if (currentFriend.backgroundImage) {
                backgroundPreview.innerHTML = `<img src="${currentFriend.backgroundImage}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px;">`;
            } else {
                backgroundPreview.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--ios-text-tertiary);">æš‚æ— èƒŒæ™¯å›¾ç‰‡</div>';
            }

            // æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
            lightThemeBtn.classList.toggle('active', currentFriend.theme === 'light');
            darkThemeBtn.classList.toggle('active', currentFriend.theme === 'dark');

            // æ¸²æŸ“å­—å¡åˆ—è¡¨
            phraseList.innerHTML = '';
            currentFriend.settings.phrases.forEach((phrase, index) => {
                const phraseCard = document.createElement('div');
                phraseCard.className = 'phrase-card';
                phraseCard.innerHTML = `
                    <div class="phrase-text">${phrase}</div>
                    <div class="phrase-actions">
                        <button class="phrase-edit-btn" data-index="${index}" data-type="phrase">ç¼–è¾‘</button>
                        <button class="phrase-delete-btn" data-index="${index}" data-type="phrase">åˆ é™¤</button>
                    </div>
                `;
                phraseList.appendChild(phraseCard);
            });

            // æ¸²æŸ“è¡¨æƒ…åŒ…åˆ—è¡¨
            stickerList.innerHTML = '';
            currentFriend.settings.stickers.forEach((sticker, index) => {
                const item = document.createElement('div');
                item.className = 'image-option';
                item.innerHTML = `
                    <img src="${sticker}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                    <button class="delete-btn" data-index="${index}" data-type="sticker">Ã—</button>
                `;
                stickerList.appendChild(item);
            });

            // æ¸²æŸ“ç”¨æˆ·è¡¨æƒ…åŒ…
            userStickerList.innerHTML = '';
            appData.userStickers.forEach((sticker, index) => {
                const item = document.createElement('div');
                item.className = 'image-option';
                item.innerHTML = `
                    <img src="${sticker}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                    <button class="delete-btn" data-index="${index}" data-type="userSticker">Ã—</button>
                `;
                userStickerList.appendChild(item);
            });

            // æ›´æ–°è¡¨æƒ…åŒ…é€‰æ‹©å™¨ï¼ˆä½¿ç”¨ç”¨æˆ·è¡¨æƒ…åŒ…ï¼‰
            stickerPicker.innerHTML = '';
            appData.userStickers.forEach(sticker => {
                const imgElement = document.createElement('div');
                imgElement.className = 'image-option';
                imgElement.innerHTML = `
                    <img src="${sticker}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                `;
                imgElement.addEventListener('click', () => {
                    sendMessage(sticker, 'sticker');
                    stickerPicker.classList.add('hidden');
                });
                stickerPicker.appendChild(imgElement);
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage(content, type = 'text') {
            if (!content.trim() && type !== 'image' && type !== 'sticker' && type !== 'sticker') return;

            const currentFriend = getCurrentFriend();

            const userMessage = {
                sender: 'user',
                type: type,
                content: content,
                timestamp: Date.now()
            };

            currentFriend.messages.push(userMessage);
            addMessageToChat(userMessage);

            // ä¿å­˜æ•°æ®ï¼ˆåŒ…æ‹¬ç”¨æˆ·æ¶ˆæ¯ï¼‰
            await saveData();

            if (type === 'text') {
                messageInput.value = '';
                adjustTextareaHeight();
            }

            // ä¸ºè¿™æ¡æ¶ˆæ¯åˆ›å»ºå›å¤ä»»åŠ¡ï¼ˆä½¿ç”¨ä¸´æ—¶çŠ¶æ€ï¼‰
            createReplyTask(currentFriend.id, userMessage);
        }

        // åˆ›å»ºå›å¤ä»»åŠ¡ï¼ˆä½¿ç”¨ä¸´æ—¶çŠ¶æ€ï¼‰
        function createReplyTask(friendId, userMessage) {
            // æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
            const queueLength = replyTaskQueues[friendId] ? replyTaskQueues[friendId].length : 0;

            // åˆ›å»ºä»»åŠ¡ï¼ˆä¸åŒ…å«repliesï¼Œå»¶è¿Ÿåç”Ÿæˆï¼‰
            const task = {
                id: Date.now(),
                userMessage: userMessage,
                createdAt: Date.now(),
                type: 'reply',
                // å¦‚æœæ˜¯ç©ºé˜Ÿåˆ—ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡
                isFirstInQueue: queueLength === 0
            };

            // æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¸´æ—¶çŠ¶æ€ï¼‰
            if (!replyTaskQueues[friendId]) {
                replyTaskQueues[friendId] = [];
            }
            replyTaskQueues[friendId].push(task);

            // æ›´æ–°çŠ¶æ€ä¸º"æ­£åœ¨è¾“å…¥"
            if (appData.currentFriendId === friendId) {
                chatStatus.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
            }

            // å¦‚æœå½“å‰æ²¡æœ‰åœ¨å¤„ç†é˜Ÿåˆ—ï¼Œå¼€å§‹å¤„ç†
            if (!isProcessingQueues[friendId]) {
                processReplyTaskQueue(friendId);
            }
        }

        // ç”Ÿæˆå›å¤
        function generateReplies(friend, userMessage = null) {
            const availableTypes = [];

            // åªæ£€æŸ¥å­—å¡å’Œè¡¨æƒ…åŒ…
            if (friend.settings.phrases.length > 0) availableTypes.push('text');
            if (friend.settings.stickers.length > 0) availableTypes.push('sticker');

            if (availableTypes.length === 0) {
                return [];
            }

            // ä¸»åŠ¨å‘é€æ—¶ä¹Ÿä½¿ç”¨æ‰¹é‡å‘é€è®¾ç½®
            const replyCount = friend.settings.multiMessageEnabled ?
                Math.floor(Math.random() * 5) + 1 : 1;

            // ä¸ºæ¯æ¡å›å¤åˆ›å»ºå†…å®¹
            const replies = [];
            for (let i = 0; i < replyCount; i++) {
                const randomType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                let replyContent = '';

                // å†³å®šæ˜¯å¦å¼•ç”¨ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ¯æ¡æ¶ˆæ¯ç‹¬ç«‹20%æ¦‚ç‡ï¼‰
                let shouldQuote = false;
                let quoteMessage = null;
                if (friend.settings.enableQuoteReply && Math.random() < 0.2) {
                    shouldQuote = true;

                    // ä»ç”¨æˆ·çš„å†å²æ¶ˆæ¯ä¸­éšæœºé€‰æ‹©ä¸€æ¡ï¼ˆæœ€è¿‘10æ¡ï¼‰
                    const userMessages = friend.messages.filter(m => m.sender === 'user');
                    const recentUserMessages = userMessages.slice(-10); // å–æœ€è¿‘10æ¡

                    if (recentUserMessages.length > 0) {
                        // å®Œå…¨éšæœºé€‰æ‹©ä¸€æ¡ï¼Œä¸ä¼˜å…ˆå½“å‰æ¶ˆæ¯
                        quoteMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
                    }
                }

                if (randomType === 'text') {
                    const randomIndex = Math.floor(Math.random() * friend.settings.phrases.length);
                    replyContent = friend.settings.phrases[randomIndex];
                } else if (randomType === 'sticker') {
                    const randomIndex = Math.floor(Math.random() * friend.settings.stickers.length);
                    replyContent = friend.settings.stickers[randomIndex];
                }

                const botMessage = {
                    sender: 'bot',
                    type: randomType,
                    content: replyContent,
                    timestamp: Date.now() // ä¼šåœ¨å‘é€æ—¶æ›´æ–°ä¸ºå®é™…æ—¶é—´
                };

                // å¦‚æœæœ‰å¼•ç”¨ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                if (quoteMessage && shouldQuote) {
                    botMessage.quote = quoteMessage.content;
                    botMessage.quoteType = quoteMessage.type;
                    botMessage.quoteSender = appData.userName;
                }

                replies.push(botMessage);
            }

            return replies;
        }

        // å¤„ç†å›å¤ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä½¿ç”¨ä¸´æ—¶çŠ¶æ€ï¼‰
        function processReplyTaskQueue(friendId) {
            const friend = appData.friends[friendId];
            if (!friend) return;

            // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œç»“æŸå¤„ç†
            if (!replyTaskQueues[friendId] || replyTaskQueues[friendId].length === 0) {
                isProcessingQueues[friendId] = false;

                // æ›´æ–°çŠ¶æ€ä¸ºåœ¨çº¿
                if (appData.currentFriendId === friendId) {
                    chatStatus.textContent = "åœ¨çº¿";
                }
                return;
            }

            // æ ‡è®°ä¸ºæ­£åœ¨å¤„ç†
            isProcessingQueues[friendId] = true;

            // è·å–å½“å‰ä»»åŠ¡
            const currentTask = replyTaskQueues[friendId][0];

            // è®¡ç®—å»¶è¿Ÿï¼šå¦‚æœæ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå»¶è¿Ÿ30ç§’-1åˆ†é’Ÿï¼›å¦åˆ™å»¶è¿Ÿ10-20ç§’
            const delay = currentTask.isFirstInQueue ?
                Math.floor(Math.random() * 30000) + 30000 : // 30ç§’-1åˆ†é’Ÿ
                Math.floor(Math.random() * 10000) + 10000;  // 10-20ç§’

            console.log(`ä»»åŠ¡ ${currentTask.id} å°†åœ¨ ${delay / 1000} ç§’åæ‰§è¡Œï¼Œé˜Ÿåˆ—é•¿åº¦: ${replyTaskQueues[friendId].length}, æ˜¯å¦ç¬¬ä¸€ä¸ª: ${currentTask.isFirstInQueue}, ä»»åŠ¡ç±»å‹: ${currentTask.type}`);

            // è®¾ç½®å»¶è¿Ÿåæ‰§è¡Œä»»åŠ¡
            const timer = setTimeout(() => {
                // å»¶è¿Ÿç»“æŸåï¼Œç”Ÿæˆå›å¤æ¶ˆæ¯
                const replies = generateReplies(friend, currentTask.userMessage);
                if (replies.length === 0) {
                    // å¦‚æœæ²¡æœ‰ç”Ÿæˆå›å¤ï¼Œè·³è¿‡è¿™ä¸ªä»»åŠ¡
                    replyTaskQueues[friendId].shift();
                    processReplyTaskQueue(friendId);
                    return;
                }

                // æ‰§è¡Œä»»åŠ¡ï¼Œå‘é€æ¶ˆæ¯
                executeTaskWithReplies(friendId, replies, 0);
            }, delay);

            // ä¿å­˜å®šæ—¶å™¨å¼•ç”¨ï¼ˆä¸´æ—¶çŠ¶æ€ï¼‰
            // æ³¨æ„ï¼šè¿™åªæ˜¯ä¸ºäº†èƒ½åœ¨éœ€è¦æ—¶å–æ¶ˆï¼Œä¸ä¿å­˜åˆ°IndexedDB
        }

        // æ‰§è¡Œä»»åŠ¡ï¼ˆä¸²è¡Œå‘é€æ¶ˆæ¯ï¼‰
        function executeTaskWithReplies(friendId, replies, messageIndex) {
            const friend = appData.friends[friendId];
            if (!friend || !replies || messageIndex >= replies.length) {
                // ä»»åŠ¡å®Œæˆï¼Œä»é˜Ÿåˆ—ä¸­ç§»é™¤
                if (replyTaskQueues[friendId] && replyTaskQueues[friendId].length > 0) {
                    replyTaskQueues[friendId].shift();
                }

                // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡
                processReplyTaskQueue(friendId);
                return;
            }

            const reply = replies[messageIndex];

            // æ·»åŠ æ—¶é—´æˆ³
            reply.timestamp = Date.now();

            // æ·»åŠ åˆ°æ¶ˆæ¯è®°å½•
            friend.messages.push(reply);

            // ä¿å­˜æ¶ˆæ¯åˆ°IndexedDB
            saveData();

            // å¦‚æœå½“å‰æŸ¥çœ‹çš„æ˜¯è¿™ä¸ªå¥½å‹çš„èŠå¤©ï¼Œåˆ™æ›´æ–°èŠå¤©ç•Œé¢
            if (appData.currentFriendId === friendId) {
                addMessageToChat(reply);
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
                // å¦‚æœä¸æ˜¯å½“å‰å¥½å‹ï¼Œå¢åŠ æœªè¯»è®¡æ•°
                friend.unreadCount++;
                renderFriendsList();
            }

            // å¦‚æœè¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œè®¾ç½®ä¸‹ä¸€ä¸ªå»¶è¿Ÿï¼ˆ3-5ç§’ï¼‰
            if (messageIndex < replies.length - 1) {
                const nextDelay = Math.floor(Math.random() * 2000) + 3000; // 3-5ç§’
                setTimeout(() => {
                    executeTaskWithReplies(friendId, replies, messageIndex + 1);
                }, nextDelay);
            } else {
                // è¿™æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œä»»åŠ¡å®Œæˆ
                setTimeout(() => {
                    // ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡
                    if (replyTaskQueues[friendId] && replyTaskQueues[friendId].length > 0) {
                        replyTaskQueues[friendId].shift();
                    }

                    // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡
                    processReplyTaskQueue(friendId);
                }, 1000);
            }
        }

        //å‘é€æ¶ˆæ¯ã€‚
        function addMessageToChat(msg) {
            const currentFriend = getCurrentFriend();
            const index = currentFriend.messages.length - 1;

            // âœ… ç›´æ¥å¤ç”¨å·²æœ‰çš„å•æ¡æ¸²æŸ“é€»è¾‘
            const node = renderSingleMessage(msg, index, currentFriend);

            chatArea.appendChild(node);

            // âœ… å‘é€æ¶ˆæ¯åè‡ªåŠ¨æ»šåˆ°åº•éƒ¨
            requestAnimationFrame(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
            });
        }

        //è¾“å…¥æ å˜åŒ–é«˜åº¦
        const textarea = document.querySelector('.message-input');
        const wrapper = document.querySelector('.input-wrapper');

        const MIN_HEIGHT = 48.67; // å•è¡Œç²¾ç¡®é«˜åº¦
        const MAX_HEIGHT = 92;    // ä¸‰è¡Œå°é¡¶é«˜åº¦

        function adjustTextareaHeight() {
            textarea.style.height = 'auto';

            const contentHeight = Math.min(textarea.scrollHeight, MAX_HEIGHT);

            textarea.style.height = contentHeight + 'px';
            wrapper.style.height = Math.max(MIN_HEIGHT, contentHeight) + 'px';
        }

        // è¾“å…¥æ—¶è°ƒæ•´é«˜åº¦
        textarea.addEventListener('input', adjustTextareaHeight);

        // é¡µé¢åˆå§‹åŒ–æ—¶ä¹Ÿè·‘ä¸€æ¬¡ï¼ˆé˜²æ­¢å›å¡«å†…å®¹ï¼‰
        window.addEventListener('load', adjustTextareaHeight);
        // æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•
        function clearChatHistory() {
            const currentFriend = getCurrentFriend();
            currentFriend.messages = [];
            currentFriend.unreadCount = 0; // æ¸…é™¤æœªè¯»è®¡æ•°
            saveData().then(success => {
                if (success) {
                    renderChat();
                    renderFriendsList();
                } else {
                    alert("æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            });
        }

        // å¯¼å‡ºèŠå¤©è®°å½•ä¸ºå¯å¤åˆ¶æ–‡æœ¬
        function exportChatHistory() {
            const currentFriend = getCurrentFriend();

            if (currentFriend.messages.length === 0) {
                alert("æ²¡æœ‰èŠå¤©è®°å½•å¯ä»¥å¯¼å‡º");
                return;
            }

            let exportTextContent = `=== ${appData.userName} ä¸ ${currentFriend.name} çš„èŠå¤©è®°å½• ===\n\n`;
            let lastDate = null;

            currentFriend.messages.forEach((msg, index) => {
                const msgDate = new Date(msg.timestamp);
                const currentDate = msgDate.toDateString();

                if (index === 0 || currentDate !== lastDate) {
                    exportTextContent += `\n--- ${formatDate(msg.timestamp)} ---\n\n`;
                    lastDate = currentDate;
                }

                const timeStr = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const senderName = msg.sender === 'user' ? appData.userName : currentFriend.name;

                exportTextContent += `${timeStr} ${senderName}ï¼š`;

                if (msg.type === 'text') {
                    exportTextContent += `${msg.content}\n`;
                } else if (msg.type === 'image') {
                    exportTextContent += `[å›¾ç‰‡]\n`;
                } else if (msg.type === 'emoji') {
                    exportTextContent += `${msg.content}\n`;
                } else if (msg.type === 'sticker') {
                    exportTextContent += `[è¡¨æƒ…åŒ…]\n`;
                }
            });

            exportTextContent += `\n=== èŠå¤©è®°å½•ç»“æŸ ===`;

            // æ˜¾ç¤ºå¯¼å‡ºæ–‡æœ¬åŒºåŸŸ
            exportText.value = exportTextContent;
            exportTextarea.style.display = 'flex';
        }

        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            exportSuccess.style.display = 'block';
            setTimeout(() => {
                exportSuccess.style.display = 'none';
            }, 2000);
        }

        // å‹ç¼©å›¾ç‰‡å‡½æ•°
        function compressImage(file, quality = 0.8, maxWidth = 200) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (event) {
                    const img = new Image();

                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // è®¡ç®—æ–°å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // ç»˜åˆ¶å¹¶å‹ç¼©å›¾ç‰‡
                        ctx.drawImage(img, 0, 0, width, height);

                        // è½¬æ¢ä¸ºå‹ç¼©åçš„base64
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };

                    img.onerror = reject;
                    img.src = event.target.result;
                };

                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // æ‰¹é‡å‹ç¼©å›¾ç‰‡
        async function batchCompressImages(files, progressCallback = null) {
            const compressedImages = [];

            for (let i = 0; i < files.length; i++) {
                try {
                    const compressedImage = await compressImage(files[i]);
                    compressedImages.push(compressedImage);

                    // æ›´æ–°è¿›åº¦
                    if (progressCallback) {
                        const progress = ((i + 1) / files.length) * 100;
                        progressCallback(progress);
                    }
                } catch (error) {
                    console.error(`å‹ç¼©å›¾ç‰‡å¤±è´¥: ${files[i].name}`, error);
                }
            }

            return compressedImages;
        }

        // ä¸»åŠ¨å‘é€æ¶ˆæ¯
        function scheduleActiveMessage(friendId) {
            const friend = appData.friends[friendId];
            if (!friend || !friend.settings.activeSending) return;

            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (activeSendingTimers[friendId]) {
                clearTimeout(activeSendingTimers[friendId]);
            }

            // è®¡ç®—ä¸‹æ¬¡å‘é€æ—¶é—´ï¼ˆ2-10åˆ†é’Ÿï¼‰
            const nextDelayMs = Math.floor(Math.random() * 8 * 60 * 1000) + 2 * 60 * 1000;

            console.log(`ä¸º ${friend.name} å®‰æ’ä¸»åŠ¨å‘é€ï¼Œå°†åœ¨ ${Math.round(nextDelayMs / 1000 / 60)} åˆ†é’Ÿåå‘é€`);

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            activeSendingTimers[friendId] = setTimeout(() => {
                createActiveTask(friendId);
            }, nextDelayMs);
        }

        // åˆ›å»ºä¸»åŠ¨å‘é€ä»»åŠ¡
        function createActiveTask(friendId) {
            const friend = appData.friends[friendId];
            if (!friend || !friend.settings.activeSending) return;

            console.log(`ä¸º ${friend.name} åˆ›å»ºä¸»åŠ¨å‘é€ä»»åŠ¡`);

            // æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
            const queueLength = replyTaskQueues[friendId] ? replyTaskQueues[friendId].length : 0;

            // åˆ›å»ºä»»åŠ¡ï¼ˆä¸åŒ…å«repliesï¼Œå»¶è¿Ÿåç”Ÿæˆï¼‰
            const task = {
                id: Date.now(),
                createdAt: Date.now(),
                type: 'active',
                // å¦‚æœæ˜¯ç©ºé˜Ÿåˆ—ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡
                isFirstInQueue: queueLength === 0
            };

            // æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¸´æ—¶çŠ¶æ€ï¼‰
            if (!replyTaskQueues[friendId]) {
                replyTaskQueues[friendId] = [];
            }
            replyTaskQueues[friendId].push(task);

            // æ›´æ–°çŠ¶æ€ä¸º"æ­£åœ¨è¾“å…¥"
            if (appData.currentFriendId === friendId) {
                chatStatus.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
            }

            // å¦‚æœå½“å‰æ²¡æœ‰åœ¨å¤„ç†é˜Ÿåˆ—ï¼Œå¼€å§‹å¤„ç†
            if (!isProcessingQueues[friendId]) {
                processReplyTaskQueue(friendId);
            }

            // å®‰æ’ä¸‹ä¸€æ¬¡ä¸»åŠ¨å‘é€
            scheduleActiveMessage(friendId);
        }

        // åœæ­¢æŒ‡å®šå¥½å‹çš„ä¸»åŠ¨å‘é€å®šæ—¶å™¨
        function stopActiveSending(friendId) {
            if (activeSendingTimers[friendId]) {
                clearTimeout(activeSendingTimers[friendId]);
                activeSendingTimers[friendId] = null;
                console.log(`å·²åœæ­¢ ${appData.friends[friendId].name} çš„ä¸»åŠ¨å‘é€æ¶ˆæ¯`);
            }
        }

        // âœ… é«˜æ¸…å¤´åƒå‹ç¼©ï¼ˆ3xï¼Œé˜²ç³Šï¼‰
        function compressAvatar(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (event) {
                    const img = new Image();

                    img.onload = function () {
                        const SIZE = 144; // â­ 3x å°ºå¯¸ï¼ˆ48 Ã— 3ï¼‰
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        canvas.width = SIZE;
                        canvas.height = SIZE;

                        const imgAspect = img.width / img.height;
                        let sx, sy, sw, sh;

                        if (imgAspect > 1) {
                            // æ¨ªå›¾
                            sh = img.height;
                            sw = img.height;
                            sx = (img.width - sw) / 2;
                            sy = 0;
                        } else {
                            // ç«–å›¾
                            sw = img.width;
                            sh = img.width;
                            sx = 0;
                            sy = (img.height - sh) / 2;
                        }

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        ctx.drawImage(
                            img,
                            sx, sy, sw, sh,
                            0, 0, SIZE, SIZE
                        );

                        // âœ… ç”¨ PNGï¼Œä¸è¦ JPEGï¼ˆå¤´åƒè¾¹ç¼˜ä¼šæ›´å¹²å‡€ï¼‰
                        const dataUrl = canvas.toDataURL('image/png');
                        resolve(dataUrl);
                    };

                    img.onerror = reject;
                    img.src = event.target.result;
                };

                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ä¸Šä¼ è§’è‰²å¤´åƒ
        async function uploadAvatar(file) {
            if (!file) return;

            try {
                const compressedAvatar = await compressAvatar(file);
                const currentFriend = getCurrentFriend();
                currentFriend.avatarImage = compressedAvatar;

                const saveResult = await saveData();
                if (saveResult) {
                    renderSettings();
                    alert("å¤´åƒä¸Šä¼ æˆåŠŸï¼");
                } else {
                    alert("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            } catch (error) {
                console.error("å¤´åƒå‹ç¼©å¤±è´¥:", error);
                alert("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        async function uploadUserAvatar(file) {
            if (!file) return;

            try {
                const compressedAvatar = await compressAvatar(file);
                appData.userAvatarImage = compressedAvatar;

                const saveResult = await saveData();
                if (saveResult) {
                    renderSettings();
                    renderChat();
                    alert("ç”¨æˆ·å¤´åƒä¸Šä¼ æˆåŠŸï¼");
                } else {
                    alert("ç”¨æˆ·å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            } catch (error) {
                console.error("ç”¨æˆ·å¤´åƒå‹ç¼©å¤±è´¥:", error);
                alert("ç”¨æˆ·å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        // å‹ç¼©èƒŒæ™¯å›¾ç‰‡
        function compressBackground(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (event) {
                    const img = new Image();

                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // è®¾ç½®æœ€å¤§å®½åº¦ï¼Œç¡®ä¿å›¾ç‰‡ä¸ä¼šå¤ªå¤§
                        const maxWidth = 1920;
                        let width = img.width;
                        let height = img.height;

                        // å¦‚æœå›¾ç‰‡å®½åº¦è¶…è¿‡æœ€å¤§å®½åº¦ï¼Œåˆ™æŒ‰æ¯”ä¾‹ç¼©æ”¾
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // ç»˜åˆ¶å›¾ç‰‡ï¼Œä¸è£å‰ªï¼Œåªç¼©æ”¾
                        ctx.drawImage(img, 0, 0, width, height);

                        // è½¬æ¢ä¸ºå‹ç¼©åçš„base64ï¼Œè´¨é‡0.7
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressedDataUrl);
                    };

                    img.onerror = reject;
                    img.src = event.target.result;
                };

                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ä¸Šä¼ èŠå¤©èƒŒæ™¯
        async function uploadChatBackground(file) {
            if (!file) return;

            try {
                const compressedBackground = await compressBackground(file);
                const currentFriend = getCurrentFriend();
                currentFriend.backgroundImage = compressedBackground;

                const saveResult = await saveData();
                if (saveResult) {
                    renderSettings();
                    renderChat();
                    alert("èŠå¤©èƒŒæ™¯ä¸Šä¼ æˆåŠŸï¼");
                } else {
                    alert("èŠå¤©èƒŒæ™¯ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            } catch (error) {
                console.error("èƒŒæ™¯å‹ç¼©å¤±è´¥:", error);
                alert("èŠå¤©èƒŒæ™¯ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        // åº”ç”¨ä¸»é¢˜
        function applyTheme(theme) {
            // ç§»é™¤ç°æœ‰çš„ä¸»é¢˜ç±»
            document.body.classList.remove('dark-theme');

            // åº”ç”¨æ–°ä¸»é¢˜
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            }

            // ä¿å­˜ä¸»é¢˜è®¾ç½®
            saveData();
        }

        // æ‰“å¼€é¢æ¿
        function openPanel(panel) {
            panel.classList.add('active');
            overlay.classList.add('active');
        }

        // å…³é—­é¢æ¿
        function closePanel() {
            settingsPanel.classList.remove('active');
            friendsPanel.classList.remove('active');
            addFriendPopup.classList.remove('active');
            phraseMorePopup.classList.remove('active');
            overlay.classList.remove('active');
        }

        // æ‰¹é‡æ·»åŠ å­—å¡
        function batchAddPhrases(text) {
            if (!text.trim()) return;

            const currentFriend = getCurrentFriend();

            // æŒ‰è¡Œåˆ†å‰²æ–‡æœ¬ï¼Œè¿‡æ»¤ç©ºè¡Œ
            const phrases = text.split('\n')
                .map(phrase => phrase.trim())
                .filter(phrase => phrase.length > 0);

            if (phrases.length === 0) {
                alert("æ²¡æœ‰æœ‰æ•ˆçš„å­—å¡å†…å®¹");
                return;
            }

            // æ·»åŠ åˆ°å­—å¡åˆ—è¡¨
            currentFriend.settings.phrases.push(...phrases);

            // ä¿å­˜æ•°æ®
            saveData();

            // é‡æ–°æ¸²æŸ“è®¾ç½®ç•Œé¢
            renderSettings();

            // å…³é—­å¼¹çª—
            batchPhrasePopup.classList.remove('active');
            overlay.classList.remove('active');

            // æ¸…ç©ºæ–‡æœ¬åŸŸ
            batchPhraseTextarea.value = '';

            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸæ¶ˆæ¯
            alert(`æˆåŠŸæ·»åŠ äº† ${phrases.length} ä¸ªå­—å¡`);
        }

        // åˆ é™¤å…¨éƒ¨å­—å¡
        function deleteAllPhrases() {
            const currentFriend = getCurrentFriend();

            if (currentFriend.settings.phrases.length === 0) {
                alert("å½“å‰æ²¡æœ‰å­—å¡å¯ä»¥åˆ é™¤");
                return;
            }

            if (confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å­—å¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
                currentFriend.settings.phrases = [];
                saveData();
                renderSettings();
                alert("å·²åˆ é™¤æ‰€æœ‰å­—å¡");
            }
        }

        // æœç´¢å­—å¡
        function searchPhrases(keyword) {
            const currentFriend = getCurrentFriend();
            const phrases = currentFriend.settings.phrases;

            if (!keyword.trim()) {
                phraseSearchResults.innerHTML = '<div class="no-results">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
                return;
            }

            const searchResults = phrases.filter((phrase, index) =>
                phrase.toLowerCase().includes(keyword.toLowerCase())
            );

            phraseSearchResults.innerHTML = '';

            if (searchResults.length === 0) {
                phraseSearchResults.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°ç›¸å…³å­—å¡</div>';
                return;
            }

            searchResults.forEach((phrase, resultIndex) => {
                // æ‰¾åˆ°åŸå§‹ç´¢å¼•
                const originalIndex = phrases.indexOf(phrase);

                const resultItem = document.createElement('div');
                resultItem.className = 'phrase-search-result-item';
                resultItem.innerHTML = `
                    <div class="phrase-search-result-text">${phrase}</div>
                    <div class="phrase-search-result-actions">
                        <button class="phrase-search-edit-btn" data-index="${originalIndex}">ç¼–è¾‘</button>
                        <button class="phrase-search-delete-btn" data-index="${originalIndex}">åˆ é™¤</button>
                    </div>
                `;
                phraseSearchResults.appendChild(resultItem);
            });

            // æ·»åŠ æœç´¢ç»“æœçš„äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.phrase-search-edit-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-index'));
                    const currentFriend = getCurrentFriend();
                    const phrase = currentFriend.settings.phrases[index];

                    const newPhraseText = prompt("ç¼–è¾‘å­—å¡å†…å®¹:", phrase);
                    if (newPhraseText !== null && newPhraseText.trim() !== '') {
                        currentFriend.settings.phrases[index] = newPhraseText.trim();
                        saveData();
                        renderSettings();
                        // é‡æ–°æœç´¢
                        searchPhrases(phraseSearchInput.value);
                    }
                });
            });

            document.querySelectorAll('.phrase-search-delete-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-index'));
                    const currentFriend = getCurrentFriend();

                    if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­—å¡å—ï¼Ÿ")) {
                        currentFriend.settings.phrases.splice(index, 1);
                        saveData();
                        renderSettings();
                        // é‡æ–°æœç´¢
                        searchPhrases(phraseSearchInput.value);
                    }
                });
            });
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', async () => {
            await sendMessage(messageInput.value);
        });

        messageInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await sendMessage(messageInput.value);
            }
        });

        messageInput.addEventListener('input', adjustTextareaHeight);

        settingsBtn.addEventListener('click', () => {
            openPanel(settingsPanel);
            updateStorageInfo();
        });

        closeSettings.addEventListener('click', closePanel);

        // === Sticker ===
        if (stickerBtn && stickerPicker) {
            stickerBtn.addEventListener('click', () => {
                stickerPicker.classList.toggle('hidden');
            });
        }

        // === Image ===
        if (imageBtn && imageFileInput) {
            imageBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è¢«æ‹–æ‹½é€»è¾‘åƒæ‰
                imageFileInput.click();
            });
        }

        // === Image file change ===
        if (imageFileInput) {
            imageFileInput.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                const file = files[0];
                const reader = new FileReader();

                reader.onload = async (event) => {
                    await sendMessage(event.target.result, 'image');
                    imageFileInput.value = '';
                };

                reader.readAsDataURL(file);
            });
        }

        userNameInput.addEventListener('change', () => {
            appData.userName = userNameInput.value;
            saveData();
        });

        botNameInput.addEventListener('change', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.name = botNameInput.value;
            saveData();
        });

        multiMessageToggle.addEventListener('change', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.settings.multiMessageEnabled = multiMessageToggle.checked;
            saveData();
        });

        // ä¸»åŠ¨å‘é€æ¶ˆæ¯å¼€å…³äº‹ä»¶
        activeSendingToggle.addEventListener('change', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.settings.activeSending = activeSendingToggle.checked;

            if (currentFriend.settings.activeSending) {
                scheduleActiveMessage(currentFriend.id);
            } else {
                stopActiveSending(currentFriend.id);
            }

            saveData();
        });

        // å¼•ç”¨æ¶ˆæ¯å›å¤å¼€å…³äº‹ä»¶
        quoteReplyToggle.addEventListener('change', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.settings.enableQuoteReply = quoteReplyToggle.checked;
            saveData();
        });

        // ä½¿ç”¨è‡ªå®šä¹‰èƒŒæ™¯å¼€å…³äº‹ä»¶
        useCustomBackgroundToggle.addEventListener('change', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.useCustomBackground = useCustomBackgroundToggle.checked;
            saveData();
            renderChat();
        });

        clearHistoryBtn.addEventListener('click', () => {
            document.getElementById('confirmTitle').textContent = "ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ";
            confirmDialog.style.display = 'flex';
        });

        confirmYes.addEventListener('click', () => {
            clearChatHistory();
            confirmDialog.style.display = 'none';
        });

        confirmNo.addEventListener('click', () => {
            confirmDialog.style.display = 'none';
        });

        exportHistoryBtn.addEventListener('click', () => {
            exportChatHistory();
        });

        copyExportBtn.addEventListener('click', () => {
            copyToClipboard(exportText.value);
        });

        closeExportBtn.addEventListener('click', () => {
            exportTextarea.style.display = 'none';
        });

        // ç‚¹å‡»å­—å¡è¾“å…¥æ¡†æ‰“å¼€æ‰¹é‡è¾“å…¥å¼¹çª—
        newPhrase.addEventListener('click', () => {
            batchPhrasePopup.classList.add('active');
            overlay.classList.add('active');
            batchPhraseTextarea.focus();
        });

        // ç‚¹å‡»"æ›´å¤š"æŒ‰é’®æ‰“å¼€å­—å¡ç®¡ç†å¼¹çª—
        morePhraseBtn.addEventListener('click', () => {
            phraseMorePopup.classList.add('active');
            overlay.classList.add('active');
            phraseSearchInput.value = '';
            phraseSearchResults.innerHTML = '<div class="no-results">è¾“å…¥å…³é”®è¯æœç´¢å­—å¡</div>';
        });

        // æ‰¹é‡å­—å¡å¼¹çª—æŒ‰é’®äº‹ä»¶
        confirmBatchPhraseBtn.addEventListener('click', () => {
            batchAddPhrases(batchPhraseTextarea.value);
        });

        cancelBatchPhraseBtn.addEventListener('click', () => {
            batchPhrasePopup.classList.remove('active');
            overlay.classList.remove('active');
            batchPhraseTextarea.value = '';
        });

        // å­—å¡ç®¡ç†å¼¹çª—æŒ‰é’®äº‹ä»¶
        deleteAllPhrasesBtn.addEventListener('click', deleteAllPhrases);

        searchPhraseBtn.addEventListener('click', () => {
            searchPhrases(phraseSearchInput.value);
        });

        // å­—å¡æœç´¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        phraseSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchPhrases(phraseSearchInput.value);
            }
        });

        closePhraseMorePopupBtn.addEventListener('click', () => {
            phraseMorePopup.classList.remove('active');
            overlay.classList.remove('active');
        });

        // å¥½å‹ç›¸å…³äº‹ä»¶ç›‘å¬
        avatarContainer.addEventListener('click', () => {
            // ç‚¹å‡»è§’è‰²ä¿¡æ¯è§¦å‘å¥½å‹åˆ—è¡¨
            openPanel(friendsPanel);
        });

        closeFriends.addEventListener('click', closePanel);

        addFriendHeaderBtn.addEventListener('click', () => {
            addFriendPopup.classList.add('active');
            newFriendName.focus();
        });

        addFriendBtn.addEventListener('click', () => {
            addFriend(newFriendName.value);
        });

        cancelAddFriendBtn.addEventListener('click', () => {
            addFriendPopup.classList.remove('active');
            newFriendName.value = '';
        });

        // å­˜å‚¨ä¼˜åŒ–ç›¸å…³äº‹ä»¶ç›‘å¬
        clearOldMessagesBtn.addEventListener('click', () => {
            clearOldMessages();
        });

        // è¡¨æƒ…åŒ…ä¸Šä¼ æŒ‰é’®äº‹ä»¶
        uploadStickerBtn.addEventListener('click', () => {
            stickerFile.click();
        });

        stickerFile.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                // æ˜¾ç¤ºåŠ è½½ç•Œé¢
                loadingOverlay.style.display = 'flex';
                compressionProgress.style.width = '0%';

                try {
                    // æ‰¹é‡å‹ç¼©å›¾ç‰‡
                    const compressedImages = await batchCompressImages(
                        files,
                        (progress) => {
                            compressionProgress.style.width = `${progress}%`;
                        }
                    );

                    // æ·»åŠ åˆ°å¥½å‹è¡¨æƒ…åŒ…åˆ—è¡¨
                    const currentFriend = getCurrentFriend();
                    currentFriend.settings.stickers.push(...compressedImages);
                    await saveData();
                    renderSettings();
                } catch (error) {
                    console.error("æ‰¹é‡å‹ç¼©å›¾ç‰‡å¤±è´¥:", error);
                    alert("å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œè¯·é‡è¯•");
                } finally {
                    // éšè—åŠ è½½ç•Œé¢
                    loadingOverlay.style.display = 'none';
                    compressionProgress.style.width = '0%';
                }
            }
        });

        // ç”¨æˆ·è¡¨æƒ…åŒ…ä¸Šä¼ æŒ‰é’®äº‹ä»¶
        uploadUserStickerBtn.addEventListener('click', () => {
            userStickerFile.click();
        });

        userStickerFile.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                // æ˜¾ç¤ºåŠ è½½ç•Œé¢
                loadingOverlay.style.display = 'flex';
                userCompressionProgress.style.width = '0%';

                try {
                    // æ‰¹é‡å‹ç¼©å›¾ç‰‡
                    const compressedImages = await batchCompressImages(
                        files,
                        (progress) => {
                            userCompressionProgress.style.width = `${progress}%`;
                        }
                    );

                    // æ·»åŠ åˆ°ç”¨æˆ·è¡¨æƒ…åŒ…åˆ—è¡¨
                    appData.userStickers.push(...compressedImages);
                    await saveData();
                    renderSettings();
                } catch (error) {
                    console.error("æ‰¹é‡å‹ç¼©å›¾ç‰‡å¤±è´¥:", error);
                    alert("å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œè¯·é‡è¯•");
                } finally {
                    // éšè—åŠ è½½ç•Œé¢
                    loadingOverlay.style.display = 'none';
                    userCompressionProgress.style.width = '0%';
                }
            }
        });

        // è§’è‰²å¤´åƒä¸Šä¼ äº‹ä»¶
        uploadAvatarBtn.addEventListener('click', () => {
            avatarFileInput.click();
        });

        avatarFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const file = files[0];
                uploadAvatar(file);
                avatarFileInput.value = '';
            }
        });

        uploadUserAvatarBtn.addEventListener('click', () => {
            userAvatarFileInput.click();
        });

        userAvatarFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const file = files[0];
                uploadUserAvatar(file);
                userAvatarFileInput.value = '';
            }
        });

        // èƒŒæ™¯ä¸Šä¼ äº‹ä»¶
        uploadChatBackgroundBtn.addEventListener('click', () => {
            chatBackgroundFileInput.click();
        });

        chatBackgroundFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const file = files[0];
                uploadChatBackground(file);
                chatBackgroundFileInput.value = '';
            }
        });

        // æ¶ˆæ¯æ“ä½œèœå•äº‹ä»¶
        copyMessageBtn.addEventListener('click', () => {
            if (currentSelectedMessage) {
                copyToClipboard(currentSelectedMessage.content);
                copySuccess.style.display = 'block';
                setTimeout(() => {
                    copySuccess.style.display = 'none';
                }, 2000);
            }
            messageActionMenu.style.display = 'none';
        });

        // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®äº‹ä»¶
        lightThemeBtn.addEventListener('click', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.theme = 'light';
            applyTheme('light');
            renderSettings();
            saveData();
        });

        darkThemeBtn.addEventListener('click', () => {
            const currentFriend = getCurrentFriend();
            currentFriend.theme = 'dark';
            applyTheme('dark');
            renderSettings();
            saveData();
        });

        // é®ç½©å±‚ç‚¹å‡»äº‹ä»¶
        overlay.addEventListener('click', closePanel);

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æ¶ˆæ¯æ“ä½œèœå•
        document.addEventListener('click', (e) => {
            if (!messageActionMenu.contains(e.target) && !e.target.classList.contains('message')) {
                messageActionMenu.style.display = 'none';
            }

            // å­—å¡ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆè®¾ç½®ç•Œé¢ä¸­çš„ï¼‰
            if (e.target.classList.contains('phrase-edit-btn')) {
                const index = e.target.getAttribute('data-index');
                const currentFriend = getCurrentFriend();
                const phrase = currentFriend.settings.phrases[index];

                const newPhraseText = prompt("ç¼–è¾‘å­—å¡å†…å®¹:", phrase);
                if (newPhraseText !== null && newPhraseText.trim() !== '') {
                    currentFriend.settings.phrases[index] = newPhraseText.trim();
                    saveData();
                    renderSettings();
                }
            } else if (e.target.classList.contains('phrase-delete-btn')) {
                const index = e.target.getAttribute('data-index');
                const currentFriend = getCurrentFriend();

                if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­—å¡å—ï¼Ÿ")) {
                    currentFriend.settings.phrases.splice(index, 1);
                    saveData();
                    renderSettings();
                }
            } else if (e.target.classList.contains('delete-btn')) {
                const index = e.target.getAttribute('data-index');
                const type = e.target.getAttribute('data-type');
                const currentFriend = getCurrentFriend();

                if (type === 'sticker') {
                    currentFriend.settings.stickers.splice(index, 1);
                } else if (type === 'userSticker') {
                    appData.userStickers.splice(index, 1);
                }

                saveData();
                renderSettings();
            }
        });

        // åˆå§‹åŒ–
        (async function () {
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œéšè—ä¸»å®¹å™¨
            initialLoading.style.display = 'flex';
            mainContainer.style.display = 'none';

            // ç¡®ä¿è¡¨æƒ…åŒ…å‹ç¼©åŠ è½½ç•Œé¢æ˜¯éšè—çš„
            loadingOverlay.style.display = 'none';

            try {
                // å¼‚æ­¥åŠ è½½æ•°æ®
                await loadData();

                // ç¡®ä¿æ‰€æœ‰æ¸²æŸ“å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 100));

                // ç¡®ä¿èŠå¤©åŒºåŸŸæ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                }, 50);

                // ç¡®ä¿æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 100));

                // ç›´æ¥åˆ‡æ¢ï¼šéšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºä¸»å®¹å™¨ï¼ˆæ— è¿‡æ¸¡æ•ˆæœï¼‰
                initialLoading.style.display = 'none';
                mainContainer.style.display = 'flex';

                // å†æ¬¡ç¡®ä¿æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                }, 50);

            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºä¸»ç•Œé¢
                initialLoading.style.display = 'none';
                mainContainer.style.display = 'flex';
                alert("åˆå§‹åŒ–å¤±è´¥ï¼Œä½†åº”ç”¨å·²å¯åŠ¨");
            }

            // ç¡®ä¿è¡¨æƒ…åŒ…é€‰æ‹©å™¨éšè—
            stickerPicker.classList.add('hidden');
        })();

        // ç¦æ­¢ç¼©æ”¾å’Œå·¦å³æ»‘åŠ¨
        document.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        document.addEventListener('gesturestart', function (event) {
            event.preventDefault();
        });

        document.addEventListener('gesturechange', function (event) {
            event.preventDefault();
        });

        document.addEventListener('gestureend', function (event) {
            event.preventDefault();
        });

        // é˜²æ­¢è®¾ç½®é¢æ¿å·¦å³æ»‘åŠ¨
        settingsPanel.addEventListener('touchmove', function (e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // é˜²æ­¢å¥½å‹é¢æ¿å·¦å³æ»‘åŠ¨
        friendsPanel.addEventListener('touchmove', function (e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // é™åˆ¶è¡¨æƒ…åŒ…é€‰æ‹©æ¡†åªèƒ½ä¸Šä¸‹æ»‘åŠ¨
        stickerPicker.addEventListener('touchmove', function (e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>

</html>